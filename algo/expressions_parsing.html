<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>MAXimal :: algo :: Разбор выражений. Обратная польская нотация</title><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><meta name="author" lang="ru" content="e-maxx" /><meta name="description" content="Алгоритмы, олимпиадное программирование, математика" /><meta name="keywords" content="алгоритмы программирование" /><meta name="google-site-verification" content="Pnjjj2XuxB0CTiqgDDvkp79bfSeDQ8Vw57iNeDJZkSc" /><link rel="stylesheet" type="text/css" href="../data/style.css"><script type="text/javascript" src="../data/jquery.js"></script><script type="text/javascript" src="../data/page-contents.js"></script><link rel="stylesheet" type="text/css" href="../geshi/geshi.css"><!--[if IE]><style>.menu a, .menu a:hover { width: 100%; }</style><![endif]--></head><body><table class=main cellpadding=0 cellspacing=0><tr><td class=title colspan=2><p>MAXimal</p></td></tr><tr><td class=menu><ul><li><a href="../index.php.html" >home</a></li><li><a href="index.html" class=current>algo</a></li><li><a href="../bookz/index.html" >bookz</a></li><li><a href="../forum/index.html" >forum</a></li><li><a href="../about.php.html" >about</a></li></ul></td><td class=content><p class=algoinfo>добавлено: 11 Jun 2008 10:44<br>редактировано: 10 Sep 2012 14:08</p><div id="contents-table"><p id="contents-table-title">Содержание <a href="expressions_parsing.html#" id="contents-hide">[скрыть]</a><a href="expressions_parsing.html#" id="contents-show" style="display:none">[показать]</a></p><div style="display:none"></div></div><h1>Разбор выражений. Обратная польская нотация</h1><p>Дана строка, представляющая собой математическое выражение, содержащее числа, переменные, различные операции. Требуется вычислить его значение за <img class=tex src="../tex2png/cache/ad5a094bea72e51fb50321739f51ec0d.png" alt="O (n)">, где <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> &mdash; длина строки.<p>Здесь описан алгоритм, который переводит это выражение в так называемую <b>обратную польскую нотацию</b> (явным или неявным образом), и уже в ней вычисляет выражение.<p><p><h2 style="padding-top:40px;">Обратная польская нотация</h2><p>Обратная польская нотация &mdash; это форма записи математических выражений, в которой операторы расположены после своих операндов.<p>Например, следующее выражение:<p><p class=formula><img class=tex src="../tex2png/cache/91830d27414ce43dcf9656e9ada2605b.png" alt=" a + b * c * d + (e - f) * (g * h + i) "></p><p>в обратной польской нотации записывается следующим образом:<p><p class=formula><img class=tex src="../tex2png/cache/0cb4cc44717fff04cf3e84112b0cd3d3.png" alt=" a b c * d * + e f - g h * i + * + "></p><p>Обратная польская нотация была разработана австралийским философом и специалистом в области теории вычислительных машин Чарльзом Хэмблином в середине 1950-х на основе польской нотации, которая была предложена в 1920 г. польским математиком Яном Лукасевичем.<p>Удобство обратной польской нотации заключается в том, что выражения, представленные в такой форме, очень <b>легко вычислять</b>, причём за линейное время. Заведём стек, изначально он пуст. Будем двигаться слева направо по выражению в обратной польской нотации; если текущий элемент &mdash; число или переменная, то кладём на вершину стека её значение; если же текущий элемент &mdash; операция, то достаём из стека два верхних элемента (или один, если операция унарная), применяем к ним операцию, и результат кладём обратно в стек. В конце концов в стеке останется ровно один элемент - значение выражения.<p>Очевидно, этот простой алгоритм выполняется за <img class=tex src="../tex2png/cache/ad5a094bea72e51fb50321739f51ec0d.png" alt="O (n)">, т.е. порядка длины выражения.<p><p><h2 style="padding-top:40px;">Разбор простейших выражений</h2><p>Пока мы рассматриваем только простейший случай: все операции <b>бинарны</b> (т.е. от двух аргументов), и все <b>левоассоциативны</b> (т.е. при равенстве приоритетов выполняются слева направо). Скобки разрешены.<p>Заведём два стека: один для чисел, другой для операций и скобок (т.е. стек символов). Изначально оба стека пусты. Для второго стека будем поддерживать предусловие, что все операции упорядочены в нём по строгому убыванию приоритета, если двигаться от вершины стека. Если в стеке есть открывающие скобки, то упорядочен каждый блок операций, находящийся между скобками, а весь стек в таком случае не обязательно упорядочен.<p>Будем идти по строке слева направо. Если текущий элемент &mdash; цифра или переменная, то положим в стек значение этого числа/переменной. Если текущий элемент &mdash; открывающая скобка, то положим её в стек. Если текущий элемент &mdash; закрывающая скобка, то будем выталкивать из стека и выполнять все операции до тех пор, пока мы не извлечём открывающую скобку (т.е., иначе говоря, встречая закрывающую скобку, мы выполняем все операции, находящиеся внутри этой скобки). Наконец, если текущий элемент &mdash; операция, то, пока на вершине стека находится операция с таким же или большим приоритетом, будем выталкивать и выполнять её.<p>После того, как мы обработаем всю строку, в стеке операций ещё могут остаться некоторые операции, которые ещё не были вычислены, и нужно выполнить их все (т.е. действуем аналогично случаю, когда встречаем закрывающую скобку).<p>Вот реализация данного метода на примере обычных операций <img class=tex src="../tex2png/cache/70b86a73b8aeb3d25d62c4e1e1961474.png" alt="+-*/\%">:<p><pre class="notranslate cpp"><span class="kw4">bool</span> delim <span class="br0">&#40;</span><span class="kw4">char</span> c<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">return</span> c <span class="sy1">==</span> <span class="st0">' '</span><span class="sy4">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">bool</span> is_op <span class="br0">&#40;</span><span class="kw4">char</span> c<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">return</span> c<span class="sy1">==</span><span class="st0">'+'</span> <span class="sy3">||</span> c<span class="sy1">==</span><span class="st0">'-'</span> <span class="sy3">||</span> c<span class="sy1">==</span><span class="st0">'*'</span> <span class="sy3">||</span> c<span class="sy1">==</span><span class="st0">'/'</span> <span class="sy3">||</span> c<span class="sy1">==</span><span class="st0">'%'</span><span class="sy4">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">int</span> priority <span class="br0">&#40;</span><span class="kw4">char</span> op<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">return</span>
		op <span class="sy1">==</span> <span class="st0">'+'</span> <span class="sy3">||</span> op <span class="sy1">==</span> <span class="st0">'-'</span> <span class="sy4">?</span> <span class="nu0">1</span> <span class="sy4">:</span>
		op <span class="sy1">==</span> <span class="st0">'*'</span> <span class="sy3">||</span> op <span class="sy1">==</span> <span class="st0">'/'</span> <span class="sy3">||</span> op <span class="sy1">==</span> <span class="st0">'%'</span> <span class="sy4">?</span> <span class="nu0">2</span> <span class="sy4">:</span>
		<span class="sy2">-</span><span class="nu0">1</span><span class="sy4">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">void</span> process_op <span class="br0">&#40;</span>vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> <span class="sy3">&amp;</span> st, <span class="kw4">char</span> op<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw4">int</span> r <span class="sy1">=</span> st.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>  st.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw4">int</span> l <span class="sy1">=</span> st.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>  st.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw1">switch</span> <span class="br0">&#40;</span>op<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw1">case</span> <span class="st0">'+'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">+</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
		<span class="kw1">case</span> <span class="st0">'-'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">-</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
		<span class="kw1">case</span> <span class="st0">'*'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">*</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
		<span class="kw1">case</span> <span class="st0">'/'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">/</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
		<span class="kw1">case</span> <span class="st0">'%'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">%</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">int</span> calc <span class="br0">&#40;</span>string <span class="sy3">&amp;</span> s<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> st<span class="sy4">;</span>
	vector<span class="sy1">&lt;</span><span class="kw4">char</span><span class="sy1">&gt;</span> op<span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">size_t</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>s.<span class="me1">length</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy3">!</span>delim <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
			<span class="kw1">if</span> <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">==</span> <span class="st0">'('</span><span class="br0">&#41;</span>
				op.<span class="me1">push_back</span> <span class="br0">&#40;</span><span class="st0">'('</span><span class="br0">&#41;</span><span class="sy4">;</span>
			<span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">==</span> <span class="st0">')'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="kw1">while</span> <span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">!</span><span class="sy1">=</span> <span class="st0">'('</span><span class="br0">&#41;</span>
					process_op <span class="br0">&#40;</span>st, op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,  op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
				op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
			<span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>is_op <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="kw4">char</span> curop <span class="sy1">=</span> s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy4">;</span>
				<span class="kw1">while</span> <span class="br0">&#40;</span><span class="sy3">!</span>op.<span class="me1">empty</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> priority<span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">&gt;=</span> priority<span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
					process_op <span class="br0">&#40;</span>st, op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,  op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
				op.<span class="me1">push_back</span> <span class="br0">&#40;</span>curop<span class="br0">&#41;</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
			<span class="kw1">else</span> <span class="br0">&#123;</span>
				string operand<span class="sy4">;</span>
				<span class="kw1">while</span> <span class="br0">&#40;</span>i <span class="sy1">&lt;</span> s.<span class="me1">length</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> <span class="kw3">isalnum</span> <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
					operand <span class="sy2">+</span><span class="sy1">=</span> s<span class="br0">&#91;</span>i<span class="sy2">++</span><span class="br0">&#93;</span><span class="sy4">;</span>
				<span class="sy2">--</span>i<span class="sy4">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">isdigit</span> <span class="br0">&#40;</span>operand<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
					st.<span class="me1">push_back</span> <span class="br0">&#40;</span><span class="kw3">atoi</span> <span class="br0">&#40;</span>operand.<span class="me1">c_str</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy4">;</span>
				<span class="kw1">else</span>
					st.<span class="me1">push_back</span> <span class="br0">&#40;</span>get_variable_val <span class="br0">&#40;</span>operand<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
	<span class="kw1">while</span> <span class="br0">&#40;</span><span class="sy3">!</span>op.<span class="me1">empty</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
		process_op <span class="br0">&#40;</span>st, op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,  op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw1">return</span> st.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
<span class="br0">&#125;</span></pre><p>Таким образом, мы научились вычислять значение выражения за <img class=tex src="../tex2png/cache/ad5a094bea72e51fb50321739f51ec0d.png" alt="O (n)">, и при этом мы неявно воспользовались обратной польской нотацией: мы расположили операции в таком порядке, когда к моменту вычисления очередной операции оба её операнда уже вычислены. Слегка модифицировав вышеописанный алгоритм, можно получить выражение в обратной польской нотаци и в явном виде.<p><p><h2 style="padding-top:40px;">Унарные операции</h2><p>Теперь предположим, что выражение содержит унарные операции (т.е. от одного аргумента). Например, особенно часто встречаются унарный плюс и минус.<p>Одно из отличий этого случая заключается в необходимости определения того, является ли текущая операция унарной или бинарной.<p>Можно заметить, что перед унарной операцией всегда стоит либо другая операция, либо открывающая скобка, либо вообще ничего (если она стоит в самом начале строки). Перед бинарной операцией, напротив, всегда стоит либо операнд (число/переменная), либо закрывающая скобка. Таким образом, достаточно завести какой-нибудь флаг для указания того, может ли следующая операция быть унарной или нет.<p>Ещё чисто реализационная тонкость &mdash; как различать унарные и бинарные операции при извлечении из стека и вычислении. Здесь можно, например, для унарных операций вместо символа <img class=tex src="../tex2png/cache/fd6f470cea3a6f4a8e40703f1a939deb.png" alt="s[i]"> класть в стек <img class=tex src="../tex2png/cache/40d3a51e16d252ccfc446d0e21470eb0.png" alt="-s[i]">.<p>Приоритет для унарных операций нужно выбирать таким, чтобы он был больше приоритетов всех бинарных операций.<p>Кроме того, надо заметить, что унарные операции фактически являются правоассоциативными &mdash; если подряд идут несколько унарных операций, то они должны обрабатываться справа налево (для описания этого случая см. ниже; приведённый здесь код уже учитывает правоассоциативность).<p>Реализация для бинарных операций <img class=tex src="../tex2png/cache/1c0295e29e5543736331bec5a033d80e.png" alt="+-*/"> и унарных операций <img class=tex src="../tex2png/cache/d4d341cdee668f1e083d5d1374bc5386.png" alt="+-">:<p><pre class="notranslate cpp"><span class="kw4">bool</span> delim <span class="br0">&#40;</span><span class="kw4">char</span> c<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">return</span> c <span class="sy1">==</span> <span class="st0">' '</span><span class="sy4">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">bool</span> is_op <span class="br0">&#40;</span><span class="kw4">char</span> c<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">return</span> c<span class="sy1">==</span><span class="st0">'+'</span> <span class="sy3">||</span> c<span class="sy1">==</span><span class="st0">'-'</span> <span class="sy3">||</span> c<span class="sy1">==</span><span class="st0">'*'</span> <span class="sy3">||</span> c<span class="sy1">==</span><span class="st0">'/'</span> <span class="sy3">||</span> c<span class="sy1">==</span><span class="st0">'%'</span><span class="sy4">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">int</span> priority <span class="br0">&#40;</span><span class="kw4">char</span> op<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>op <span class="sy1">&lt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
		<span class="kw1">return</span> <span class="nu0">4</span><span class="sy4">;</span> <span class="co1">// op == -'+' || op == -'-'</span>
	<span class="kw1">return</span>
		op <span class="sy1">==</span> <span class="st0">'+'</span> <span class="sy3">||</span> op <span class="sy1">==</span> <span class="st0">'-'</span> <span class="sy4">?</span> <span class="nu0">1</span> <span class="sy4">:</span>
		op <span class="sy1">==</span> <span class="st0">'*'</span> <span class="sy3">||</span> op <span class="sy1">==</span> <span class="st0">'/'</span> <span class="sy3">||</span> op <span class="sy1">==</span> <span class="st0">'%'</span> <span class="sy4">?</span> <span class="nu0">2</span> <span class="sy4">:</span>
		<span class="sy2">-</span><span class="nu0">1</span><span class="sy4">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">void</span> process_op <span class="br0">&#40;</span>vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> <span class="sy3">&amp;</span> st, <span class="kw4">char</span> op<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>op <span class="sy1">&lt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw4">int</span> l <span class="sy1">=</span> st.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>  st.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
		<span class="kw1">switch</span> <span class="br0">&#40;</span><span class="sy2">-</span>op<span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw1">case</span> <span class="st0">'+'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
			<span class="kw1">case</span> <span class="st0">'-'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span><span class="sy2">-</span>l<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
	<span class="kw1">else</span> <span class="br0">&#123;</span>
		<span class="kw4">int</span> r <span class="sy1">=</span> st.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>  st.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
		<span class="kw4">int</span> l <span class="sy1">=</span> st.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>  st.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
		<span class="kw1">switch</span> <span class="br0">&#40;</span>op<span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw1">case</span> <span class="st0">'+'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">+</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
			<span class="kw1">case</span> <span class="st0">'-'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">-</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
			<span class="kw1">case</span> <span class="st0">'*'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">*</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
			<span class="kw1">case</span> <span class="st0">'/'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">/</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
			<span class="kw1">case</span> <span class="st0">'%'</span><span class="sy4">:</span>  st.<span class="me1">push_back</span> <span class="br0">&#40;</span>l <span class="sy2">%</span> r<span class="br0">&#41;</span><span class="sy4">;</span>  <span class="kw1">break</span><span class="sy4">;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">int</span> calc <span class="br0">&#40;</span>string <span class="sy3">&amp;</span> s<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw4">bool</span> may_unary <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span>
	vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> st<span class="sy4">;</span>
	vector<span class="sy1">&lt;</span><span class="kw4">char</span><span class="sy1">&gt;</span> op<span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">size_t</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>s.<span class="me1">length</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy3">!</span>delim <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
			<span class="kw1">if</span> <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">==</span> <span class="st0">'('</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				op.<span class="me1">push_back</span> <span class="br0">&#40;</span><span class="st0">'('</span><span class="br0">&#41;</span><span class="sy4">;</span>
				may_unary <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
			<span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">==</span> <span class="st0">')'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="kw1">while</span> <span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">!</span><span class="sy1">=</span> <span class="st0">'('</span><span class="br0">&#41;</span>
					process_op <span class="br0">&#40;</span>st, op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,  op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
				op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
				may_unary <span class="sy1">=</span> <span class="kw2">false</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
			<span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>is_op <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="kw4">char</span> curop <span class="sy1">=</span> s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy4">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span>may_unary <span class="sy3">&amp;&amp;</span> isunary <span class="br0">&#40;</span>curop<span class="br0">&#41;</span><span class="br0">&#41;</span>  curop <span class="sy1">=</span> <span class="sy2">-</span>curop<span class="sy4">;</span>
				<span class="kw1">while</span> <span class="br0">&#40;</span><span class="sy3">!</span>op.<span class="me1">empty</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> <span class="br0">&#40;</span>
					curop <span class="sy1">&gt;=</span> <span class="nu0">0</span> <span class="sy3">&amp;&amp;</span> priority<span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">&gt;=</span> priority<span class="br0">&#40;</span>curop<span class="br0">&#41;</span>
					<span class="sy3">||</span> curop <span class="sy1">&lt;</span> <span class="nu0">0</span> <span class="sy3">&amp;&amp;</span> priority<span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">&gt;</span> priority<span class="br0">&#40;</span>curop<span class="br0">&#41;</span><span class="br0">&#41;</span>
					<span class="br0">&#41;</span>
					process_op <span class="br0">&#40;</span>st, op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,  op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
				op.<span class="me1">push_back</span> <span class="br0">&#40;</span>curop<span class="br0">&#41;</span><span class="sy4">;</span>
				may_unary <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
			<span class="kw1">else</span> <span class="br0">&#123;</span>
				string operand<span class="sy4">;</span>
				<span class="kw1">while</span> <span class="br0">&#40;</span>i <span class="sy1">&lt;</span> s.<span class="me1">length</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> <span class="kw3">isalnum</span> <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
					operand <span class="sy2">+</span><span class="sy1">=</span> s<span class="br0">&#91;</span>i<span class="sy2">++</span><span class="br0">&#93;</span><span class="sy4">;</span>
				<span class="sy2">--</span>i<span class="sy4">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">isdigit</span> <span class="br0">&#40;</span>operand<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
					st.<span class="me1">push_back</span> <span class="br0">&#40;</span><span class="kw3">atoi</span> <span class="br0">&#40;</span>operand.<span class="me1">c_str</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy4">;</span>
				<span class="kw1">else</span>
					st.<span class="me1">push_back</span> <span class="br0">&#40;</span>get_variable_val <span class="br0">&#40;</span>operand<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy4">;</span>
				may_unary <span class="sy1">=</span> <span class="kw2">false</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
	<span class="kw1">while</span> <span class="br0">&#40;</span><span class="sy3">!</span>op.<span class="me1">empty</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
		process_op <span class="br0">&#40;</span>st, op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,  op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw1">return</span> st.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
<span class="br0">&#125;</span></pre><p>Стоит заметить, что в простейших случаях, например, когда из унарных операций разрешены только <img class=tex src="../tex2png/cache/d942e26345c1e2762e50e591fb8c5c1e.png" alt="+"> и <img class=tex src="../tex2png/cache/05392a2e7e26c20fecbafb2042b75fec.png" alt="-">, правоассоциативность не играет никакой роли, поэтому в таких ситуациях никаких усложнений в схему можно не вводить. Т.е. цикл:<p><pre class="notranslate cpp">				<span class="kw1">while</span> <span class="br0">&#40;</span><span class="sy3">!</span>op.<span class="me1">empty</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> <span class="br0">&#40;</span>
					curop <span class="sy1">&gt;=</span> <span class="nu0">0</span> <span class="sy3">&amp;&amp;</span> priority<span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">&gt;=</span> priority<span class="br0">&#40;</span>curop<span class="br0">&#41;</span>
					<span class="sy3">||</span> curop <span class="sy1">&lt;</span> <span class="nu0">0</span> <span class="sy3">&amp;&amp;</span> priority<span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">&gt;</span> priority<span class="br0">&#40;</span>curop<span class="br0">&#41;</span><span class="br0">&#41;</span>
					<span class="br0">&#41;</span>
					process_op <span class="br0">&#40;</span>st, op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,  op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span></pre><p>Можно заменить на:<p><pre class="notranslate cpp">				<span class="kw1">while</span> <span class="br0">&#40;</span><span class="sy3">!</span>op.<span class="me1">empty</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> priority<span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">&gt;=</span> priority<span class="br0">&#40;</span>curop<span class="br0">&#41;</span><span class="br0">&#41;</span>
					process_op <span class="br0">&#40;</span>st, op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,  op.<span class="me1">pop_back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span></pre><p><p><h2 style="padding-top:40px;">Правоассоциативность</h2><p>Правоассоциативность оператора означает, что при равенстве приоритетов операторы вычисляются справа налево (соотвественно, левоассоциативность - когда слева направо).<p>Как уже было отмечено выше, унарные операторы обычно являются правоассоциативными. Другой пример - обычно операция возведения в степень считается правоассоциативной (действительно, a^b^c обычно воспринимается как a^(b^c), а не (a^b)^c).<p>Какие отличия нужно внести в алгоритм, чтобы корректно обрабатывать правоассоциативность? На самом деле, изменения нужны самые минимальные. Единственное отличие будет проявляться только при равенстве приоритетов, и заключается оно в том, что операции с равным приоритетом, находящиеся на вершине стека, не должны выполнять раньше текущей операции.<p>Таким образом, единственные отличия нужно внести в функцию calc:<p><pre class="notranslate cpp"><span class="kw4">int</span> calc <span class="br0">&#40;</span>string <span class="sy3">&amp;</span> s<span class="br0">&#41;</span> <span class="br0">&#123;</span>
...
				<span class="kw1">while</span> <span class="br0">&#40;</span><span class="sy3">!</span>op.<span class="me1">empty</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> <span class="br0">&#40;</span>
					left_assoc<span class="br0">&#40;</span>curop<span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> priority<span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">&gt;=</span> priority<span class="br0">&#40;</span>curop<span class="br0">&#41;</span>
					<span class="sy3">||</span> <span class="sy3">!</span>left_assoc<span class="br0">&#40;</span>curop<span class="br0">&#41;</span> <span class="sy3">&amp;&amp;</span> priority<span class="br0">&#40;</span>op.<span class="me1">back</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">&gt;</span> priority<span class="br0">&#40;</span>curop<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
...
<span class="br0">&#125;</span></pre><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr><p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'e-maxx';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script></td></tr></table></body></html>