<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>MAXimal :: algo :: Китайская теорема об остатках. Алгоритм Гарнера</title><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><meta name="author" lang="ru" content="e-maxx" /><meta name="description" content="Алгоритмы, олимпиадное программирование, математика" /><meta name="keywords" content="алгоритмы программирование" /><meta name="google-site-verification" content="Pnjjj2XuxB0CTiqgDDvkp79bfSeDQ8Vw57iNeDJZkSc" /><link rel="stylesheet" type="text/css" href="../data/style.css"><script type="text/javascript" src="../data/jquery.js"></script><script type="text/javascript" src="../data/page-contents.js"></script><link rel="stylesheet" type="text/css" href="../geshi/geshi.css"><!--[if IE]><style>.menu a, .menu a:hover { width: 100%; }</style><![endif]--></head><body><table class=main cellpadding=0 cellspacing=0><tr><td class=title colspan=2><p>MAXimal</p></td></tr><tr><td class=menu><ul><li><a href="../index.php.html" >home</a></li><li><a href="index.html" class=current>algo</a></li><li><a href="../bookz/index.html" >bookz</a></li><li><a href="../forum/index.html" >forum</a></li><li><a href="../about.php.html" >about</a></li></ul></td><td class=content><p class=algoinfo>добавлено: 11 Jul 2008 10:53<br>редактировано: 6 Sep 2012 21:57</p><div id="contents-table"><p id="contents-table-title">Содержание <a href="chinese_theorem.html#" id="contents-hide">[скрыть]</a><a href="chinese_theorem.html#" id="contents-show" style="display:none">[показать]</a></p><div style="display:none"></div></div><h1> Китайская теорема об остатках </h1><p><h2 style="padding-top:40px;"> Формулировка </h2><p>В своей современной формулировке теорема звучит так:<p>Пусть <img class=tex src="../tex2png/cache/09a49d012938bee3b7fc9b9a83b19d36.png" alt="p = p_1 \cdot p_2 \cdot \ldots \cdot p_k">, где <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i"> &mdash; попарно взаимно простые числа.<p>Поставим в соответствие произвольному числу <img class=tex src="../tex2png/cache/e4c9b6bf3a65f2e487e7cb3e199f2154.png" alt="a"> <img class=tex src="../tex2png/cache/3b439ed4bed1b3c11ed6cc169deb5c0c.png" alt="(0 \le a < p)"> кортеж <img class=tex src="../tex2png/cache/7960b6110d0646a7d61af5edf1176871.png" alt="(a_1, \ldots, a_k)">, где <img class=tex src="../tex2png/cache/0382694dc7b0fd1d5e2a484db669f6c3.png" alt="a_i \equiv a \pmod {p_i}">:<p><p class=formula><img class=tex src="../tex2png/cache/bc34691b6e12f743152046ad3f3d5665.png" alt=" a \Longleftrightarrow (a_1, \ldots, a_k). "></p><p>Тогда это соответствие (между числами и кортежами) будет являться <b>взаимно однозначным</b>. И, более того, операции, выполняемые над числом <img class=tex src="../tex2png/cache/e4c9b6bf3a65f2e487e7cb3e199f2154.png" alt="a">, можно эквивалентно выполнять над соответствующими элементами кортежами &mdash; путём независимого выполнения операций над каждым компонентом.<p>Т.е., если<p><p class=formula><img class=tex src="../tex2png/cache/946ff20db1f0046138b8b802e24b29cb.png" alt=" a \Longleftrightarrow \Big( a_1, \ldots, a_k \Big[...]"><br><img class=tex src="../tex2png/cache/7f93a8a35c02b95b79ed6c8a797fe5f2.png" alt=" b \Longleftrightarrow \Big( b_1, \ldots, b_k \Big[...]"></p><p>то справедливо:<p><p class=formula><img class=tex src="../tex2png/cache/649dffa88c3fa046fe9404295e4a4e33.png" alt=" {(a+b) \pmod p} \Longleftrightarrow \Big( {(a_1+b[...]"><br><img class=tex src="../tex2png/cache/c34a9a1b24600deb21d78b4aac9606d7.png" alt=" {(a-b) \pmod p} \Longleftrightarrow \Big( {(a_1-b[...]"><br><img class=tex src="../tex2png/cache/ec19d6f30dc3076d2a3bb6e57834a9bc.png" alt=" {(a \cdot b) \pmod p} \Longleftrightarrow \Big( {[...]"></p><p>В своей первоначальной формулировке эта теорема была доказана китайским математиком Сунь-Цзы приблизительно в 100 г. н.э. А именно, он показал в частном случае эквивалентность решения системы модулярных уравнений и решения одного модулярного уравнения (см. следствие 2 ниже).<p><p><h3 style="padding-top:15px;"> Следствие 1 </h3><p>Система модулярных уравнений:<p><p class=formula><img class=tex src="../tex2png/cache/1fa715c6701c0253cdaf06fedc12db42.png" alt=" \cases{
{x \equiv a_1 \pmod {p_1}}, \cr
\ldots,[...]"></p><p>имеет единственное решение по модулю <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p">.<p>(как и выше, <img class=tex src="../tex2png/cache/6119e4fba55000b075027e13a57d91ba.png" alt="p = p_1 \cdot \ldots \cdot p_k">, числа <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i"> попарно взаимно просты, а набор <img class=tex src="../tex2png/cache/c822ead5550b02ebbc1b6035d101c34d.png" alt="a_1, \ldots, a_k"> &mdash; произвольный набор целых чисел)<p><p><h3 style="padding-top:15px;"> Следствие 2 </h3><p>Следствием является связь между системой модулярных уравнений и одним соответствующим модулярным уравнением:<p>Уравнение:<p><p class=formula><img class=tex src="../tex2png/cache/784a779afaab3deea37264eb6630c315.png" alt=" x \equiv a \pmod p "></p><p>эквивалентно системе уравнений:<p><p class=formula><img class=tex src="../tex2png/cache/1d7820f4d80eddfc4dd51109f905c12a.png" alt=" \cases{
{x \equiv a \pmod {p_1}}, \cr
\ldots, \[...]"></p><p>(как и выше, предполагается, что <img class=tex src="../tex2png/cache/6119e4fba55000b075027e13a57d91ba.png" alt="p = p_1 \cdot \ldots \cdot p_k">, числа <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i"> попарно взаимно просты, а <img class=tex src="../tex2png/cache/e4c9b6bf3a65f2e487e7cb3e199f2154.png" alt="a"> &mdash; произвольное целое число)<p><p><h2 style="padding-top:40px;">Алгоритм Гарнера</h2><p>Из китайской теоремы об остатках следует, что можно заменять операции над числами операциями над кортежами. Напомним, каждому числу <img class=tex src="../tex2png/cache/e4c9b6bf3a65f2e487e7cb3e199f2154.png" alt="a"> ставится в соответствие кортеж <img class=tex src="../tex2png/cache/7960b6110d0646a7d61af5edf1176871.png" alt="(a_1, \ldots, a_k)">, где:<p><p class=formula><img class=tex src="../tex2png/cache/610561b834d5bb237e23b4a6fe03db8c.png" alt=" { a_i \equiv a \pmod {p_i} } . "></p><p>Это может найти широкое применение на практике (помимо непосредственного применения для восстановления числа по его остаткам по различным модулям), поскольку мы таким образом можем заменять операции в длинной арифметике операциями с массивом "коротких" чисел. Скажем, массива из <img class=tex src="../tex2png/cache/6604150f2f954e087da33d24c64e351e.png" alt="1000"> элементов "хватит" на числа примерно с <img class=tex src="../tex2png/cache/c1ee4fd79ba4cf4266b69fdbc4c7d564.png" alt="3000"> знаками (если выбрать в качестве <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i">-ых первые <img class=tex src="../tex2png/cache/6604150f2f954e087da33d24c64e351e.png" alt="1000"> простых); а если выбирать в качестве <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i">-ых простые около миллиарда, то тогда хватит уже на число с примерно <img class=tex src="../tex2png/cache/0881ef05ef20b3d111bf743121ff6a92.png" alt="9000"> знаками. Но, разумеется, тогда нужно научиться <b>восстанавливать</b> число <img class=tex src="../tex2png/cache/e4c9b6bf3a65f2e487e7cb3e199f2154.png" alt="a"> по этому кортежу. Из следствия 1 видно, что такое восстановление возможно, и притом единственно (при условии <img class=tex src="../tex2png/cache/b9129ac67e9d1627b4a3776502fad9c6.png" alt="0 \le a < p_1 \cdot p_2 \cdot \ldots \cdot p_k">). <b>Алгоритм Гарнера</b> и является алгоритмом, позволяющим выполнить это восстановление, причём достаточно эффективно.<p>Будем искать решение в виде:<p><p class=formula><img class=tex src="../tex2png/cache/011b8c975c0dc8399aa03a515a821a72.png" alt=" a = x_1 + x_2 \cdot p_1 + x_3 \cdot p_1 \cdot p_2[...]"></p><p>т.е. в смешанной системе счисления с весами разрядов <img class=tex src="../tex2png/cache/bb8be6c9083a9d97dc610bb0b9fa2749.png" alt="p_1, p_2, \ldots, p_k">.<p>Обозначим через <img class=tex src="../tex2png/cache/05301f0d7c161275680f7bba2b9fdc0a.png" alt="r_{ij}"> (<img class=tex src="../tex2png/cache/6f878b36d7730d013ddb7a33ae44503a.png" alt="i=1 \ldots k-1">, <img class=tex src="../tex2png/cache/f75374adf70b981125ad10e2b1a1a07d.png" alt="j=i+1 \ldots k">) число, являющееся обратным для <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i"> по модулю <img class=tex src="../tex2png/cache/0137555ce0c5b954ad6dd8eb08c171b4.png" alt="p_j"> (нахождение обратных элементов в кольце по модулю описано <a href="reverse_element.html">здесь</a>:<p><p class=formula><img class=tex src="../tex2png/cache/279b1261bf593913cae28e34fb0d8da4.png" alt=" r_{ij} = (p_i) ^ {-1} \pmod {p_j} . "></p><p>Подставим выражение <img class=tex src="../tex2png/cache/e4c9b6bf3a65f2e487e7cb3e199f2154.png" alt="a"> в смешанной системе счисления в первое уравнение системы, получим:<p><p class=formula><img class=tex src="../tex2png/cache/f9de112e399180add55b079a8a97f9b2.png" alt=" a_1 \equiv x_1. "></p><p>Подставим теперь выражение во второе уравнение:<p><p class=formula><img class=tex src="../tex2png/cache/c8dd9b67fbd8e357fbfe5b6123f2a185.png" alt=" a_2 \equiv x_1 + x_2 \cdot p_1 \pmod {p_2}. "></p><p>Преобразуем это выражение, отняв от обеих частей <img class=tex src="../tex2png/cache/229d7f20fba19ac5fed4f696f165dc9b.png" alt="x_1"> и разделив на <img class=tex src="../tex2png/cache/3004a92c72fcce1f45bc5afc7f7e1503.png" alt="p_1">:<p><p class=formula><img class=tex src="../tex2png/cache/ad57dc7476e7bef038602cfffe896432.png" alt=" a_2 - x_1 \equiv x_2 \cdot p_1 \pmod {p_2}; "><br><img class=tex src="../tex2png/cache/703a8977bda8e3a54f281000142494b9.png" alt=" (a_2 - x_1) \cdot r_{12} \equiv x_2 \pmod {p_2}; "><br><img class=tex src="../tex2png/cache/5de57b6d835dc69805fbfd9f9b3e6f82.png" alt=" x_2 \equiv (a_2 - x_1) \cdot r_{12} \pmod {p_2}. "></p><p>Подставляя в третье уравнение, аналогичным образом получаем:<p><p class=formula><img class=tex src="../tex2png/cache/593fa577d4a2c5087159f92fe3313806.png" alt=" a_3 \equiv { x_1 + x_2 \cdot p_1 + x_3 \cdot p_1 [...]"><br><img class=tex src="../tex2png/cache/3ae3c2a83561c2c3d34661f07b929077.png" alt=" (a_3 - x_1) \cdot r_{13} \equiv x_2 + x_3 \cdot p[...]"><br><img class=tex src="../tex2png/cache/21fcff1de8ac046e719c901fd63b9e1e.png" alt=" ((a_3 - x_1) \cdot r_{13} - x_2) \cdot r_{23} \eq[...]"><br><img class=tex src="../tex2png/cache/28537b08844fbb285deaf52be10d725c.png" alt=" x_3 \equiv ((a_3 - x_1) \cdot r_{13} - x_2) \cdot[...]"></p><p>Уже достаточно ясно видна закономерность, которую проще всего выразить кодом:<p><pre class="notranslate cpp"><span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>k<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">=</span> a<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> j<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> j<span class="sy1">&lt;</span>i<span class="sy4">;</span> <span class="sy2">++</span>j<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">=</span> r<span class="br0">&#91;</span>j<span class="br0">&#93;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy2">*</span> <span class="br0">&#40;</span>x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy2">-</span> x<span class="br0">&#91;</span>j<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy4">;</span>
&nbsp;
		x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">=</span> x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy2">%</span> p<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy4">;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">&lt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>  x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy2">+</span><span class="sy1">=</span> p<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre><p>Итак, мы научились вычислять коэффициенты <img class=tex src="../tex2png/cache/bdf4742dd10f0eb4f2b7801e40b0e129.png" alt="x_i"> за время <img class=tex src="../tex2png/cache/bbd3d8436ba49c5e1862c4b1c549d424.png" alt="O (k^2)">, сам же ответ &mdash; число <img class=tex src="../tex2png/cache/e4c9b6bf3a65f2e487e7cb3e199f2154.png" alt="a"> &mdash; можно восстановить по формуле:<p><p class=formula><img class=tex src="../tex2png/cache/82312dde280483945e0cf68f996f8abd.png" alt=" a = x_1 + x_2 \cdot p_1 + x_3 \cdot p_1 \cdot p_2[...]"></p><p>Стоит заметить, что на практике почти всегда вычислять ответ нужно с помощью <a href="big_integer.html">Длинной арифметики</a>, но при этом сами коэффициенты <img class=tex src="../tex2png/cache/bdf4742dd10f0eb4f2b7801e40b0e129.png" alt="x_i"> по-прежнему вычисляются на встроенных типах, а потому весь алгоритм Гарнера является весьма эффективным.<p><p><h2 style="padding-top:40px;">Реализация алгоритма Гарнера</h2><p>Удобнее всего реализовывать этот алгоритм на языке Java, поскольку она содержит стандартную длинную арифметику, а потому не возникает никаких проблем с переводом числа из модульной системы в обычное число (используется стандартный класс BigInteger).<p>Приведённая ниже реализация алгоритма Гарнера поддерживает сложение, вычитание и умножение, причём поддерживает работу с отрицательными числами (об этом см. пояснения после кода). Реализован перевод числа обычного десятичкого представления в модулярную систему и наоборот.<p>В данном примере берутся <img class=tex src="../tex2png/cache/42eebf03554591becb9bdde682ba1fbf.png" alt="100"> простых после <img class=tex src="../tex2png/cache/444ed8a79d12976910378f0f39064696.png" alt="10^9">, что позволяет работать с числами до примерно <img class=tex src="../tex2png/cache/842a921933fbca589eae0c394d3af6bb.png" alt="10^{900}">.<p><pre class="notranslate java"><span class="kw1">final</span> <span class="kw4">int</span> SZ <span class="sy0">=</span> <span class="nu0">100</span><span class="sy0">;</span>
<span class="kw4">int</span> pr<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw1">new</span> <span class="kw4">int</span><span class="br0">&#91;</span>SZ<span class="br0">&#93;</span><span class="sy0">;</span>
<span class="kw4">int</span> r<span class="br0">&#91;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw1">new</span> <span class="kw4">int</span><span class="br0">&#91;</span>SZ<span class="br0">&#93;</span><span class="br0">&#91;</span>SZ<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
<span class="kw4">void</span> init<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> x<span class="sy0">=</span><span class="nu0">1000</span><span class="sy0">*</span><span class="nu0">1000</span><span class="sy0">*</span><span class="nu0">1000</span>, i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>x<span class="br0">&#41;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a>.<span class="me1">valueOf</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span>.<span class="me1">isProbablePrime</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
			pr<span class="br0">&#91;</span>i<span class="sy0">++</span><span class="br0">&#93;</span> <span class="sy0">=</span> x<span class="sy0">;</span>
&nbsp;
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">&#41;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> j<span class="sy0">=</span>i<span class="sy0">+</span><span class="nu0">1</span><span class="sy0">;</span> j<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>j<span class="br0">&#41;</span>
			r<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="br0">&#93;</span> <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a>.<span class="me1">valueOf</span><span class="br0">&#40;</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="br0">&#41;</span>.<span class="me1">modInverse</span><span class="br0">&#40;</span>
					<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a>.<span class="me1">valueOf</span><span class="br0">&#40;</span> pr<span class="br0">&#91;</span>j<span class="br0">&#93;</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span>.<span class="me1">intValue</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
&nbsp;
<span class="kw1">class</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> <span class="br0">&#123;</span>
&nbsp;
	<span class="kw4">int</span> a<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw1">new</span> <span class="kw4">int</span><span class="br0">&#91;</span>SZ<span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp;
	<span class="kw1">public</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">public</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> <span class="br0">&#40;</span><span class="kw4">int</span> n<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">&#41;</span>
			a<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> n <span class="sy0">%</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">public</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a> n<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">&#41;</span>
			a<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> n.<span class="me1">mod</span><span class="br0">&#40;</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a>.<span class="me1">valueOf</span><span class="br0">&#40;</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span>.<span class="me1">intValue</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">public</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> add <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> n<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> result <span class="sy0">=</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">&#41;</span>
			result.<span class="me1">a</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#40;</span>a<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">+</span> n.<span class="me1">a</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">%</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy0">;</span>
		<span class="kw1">return</span> result<span class="sy0">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">public</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> subtract <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> n<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> result <span class="sy0">=</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">&#41;</span>
			result.<span class="me1">a</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#40;</span>a<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">-</span> n.<span class="me1">a</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">+</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">%</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy0">;</span>
		<span class="kw1">return</span> result<span class="sy0">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">public</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> multiply <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> n<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a> result <span class="sy0">=</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Anumber+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Number</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">&#41;</span>
			result.<span class="me1">a</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span><span class="br0">&#40;</span> <span class="br0">&#40;</span>a<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">*</span> 1l <span class="sy0">*</span> n.<span class="me1">a</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">%</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw1">return</span> result<span class="sy0">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">public</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a> bigIntegerValue <span class="br0">&#40;</span><span class="kw4">boolean</span> can_be_negative<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a> result <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a>.<span class="me1">ZERO</span>,
			mult <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a>.<span class="me1">ONE</span><span class="sy0">;</span>
		<span class="kw4">int</span> x<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw1">new</span> <span class="kw4">int</span><span class="br0">&#91;</span>SZ<span class="br0">&#93;</span><span class="sy0">;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>SZ<span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">&#41;</span> <span class="br0">&#123;</span>
			x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> a<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy0">;</span>
			<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> j<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> j<span class="sy0">&lt;</span>i<span class="sy0">;</span> <span class="sy0">++</span>j<span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="kw4">long</span> cur <span class="sy0">=</span> <span class="br0">&#40;</span>x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">-</span> x<span class="br0">&#91;</span>j<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">*</span> 1l <span class="sy0">*</span> r<span class="br0">&#91;</span>j<span class="br0">&#93;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy0">;</span>
				x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span><span class="br0">&#40;</span> <span class="br0">&#40;</span>cur <span class="sy0">%</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">+</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">%</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy0">;</span>					
			<span class="br0">&#125;</span>
			result <span class="sy0">=</span> result.<span class="me1">add</span><span class="br0">&#40;</span> mult.<span class="me1">multiply</span><span class="br0">&#40;</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a>.<span class="me1">valueOf</span><span class="br0">&#40;</span> x<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span>
			mult <span class="sy0">=</span> mult.<span class="me1">multiply</span><span class="br0">&#40;</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Abiginteger+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><span class="kw3">BigInteger</span></a>.<span class="me1">valueOf</span><span class="br0">&#40;</span> pr<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="br0">&#125;</span>
&nbsp;
		<span class="kw1">if</span> <span class="br0">&#40;</span>can_be_negative<span class="br0">&#41;</span>
			<span class="kw1">if</span> <span class="br0">&#40;</span>result.<span class="me1">compareTo</span><span class="br0">&#40;</span> mult.<span class="me1">shiftRight</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="sy0">&gt;=</span> <span class="nu0">0</span><span class="br0">&#41;</span>
				result <span class="sy0">=</span> result.<span class="me1">subtract</span><span class="br0">&#40;</span> mult <span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
		<span class="kw1">return</span> result<span class="sy0">;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre><p>О поддержке <b>отрицательных</b> чисел следует сказать особо (флаг <img class=tex src="../tex2png/cache/c0404aadbe329bdd06e732469f1b4bd4.png" alt="\rm can\_be\_negative"> функции <img class=tex src="../tex2png/cache/23d4f921abad48b4b9658f6478cf1aa4.png" alt="{\rm bigIntegerValue}()">). Сама модулярная схема не предполагает различий между положительными и отрицательными числами. Однако можно заметить, что, если в конкретной задаче ответ по модулю не превосходит половины от произведения всех простых, то положительные числа будут отличаться от отрицательных тем, что положительные числа получатся меньше этой середины, а отрицательные &mdash; больше. Поэтому мы после классического алгоритма Гарнера сравниваем результат с серединой, и если он больше, то выводим минус, и инвертируем результат (т.е. отнимаем его от произведения всех простых, и выводим уже его).<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr><p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'e-maxx';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script></td></tr></table></body></html>