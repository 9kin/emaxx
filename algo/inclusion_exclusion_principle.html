<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>MAXimal :: algo :: Принцип включений-исключений</title><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><meta name="author" lang="ru" content="e-maxx" /><meta name="description" content="Алгоритмы, олимпиадное программирование, математика" /><meta name="keywords" content="алгоритмы программирование" /><meta name="google-site-verification" content="Pnjjj2XuxB0CTiqgDDvkp79bfSeDQ8Vw57iNeDJZkSc" /><link rel="stylesheet" type="text/css" href="../data/style.css"><script type="text/javascript" src="../data/jquery.js"></script><script type="text/javascript" src="../data/page-contents.js"></script><link rel="stylesheet" type="text/css" href="../geshi/geshi.css"><!--[if IE]><style>.menu a, .menu a:hover { width: 100%; }</style><![endif]--></head><body><table class=main cellpadding=0 cellspacing=0><tr><td class=title colspan=2><p>MAXimal</p></td></tr><tr><td class=menu><ul><li><a href="../index.php.html" >home</a></li><li><a href="index.html" class=current>algo</a></li><li><a href="../bookz/index.html" >bookz</a></li><li><a href="../forum/index.html" >forum</a></li><li><a href="../about.php.html" >about</a></li></ul></td><td class=content><p class=algoinfo>добавлено: 25 Aug 2011 13:55<br>редактировано: 22 Oct 2011 19:29</p><div id="contents-table"><p id="contents-table-title">Содержание <a href="inclusion_exclusion_principle.html#" id="contents-hide">[скрыть]</a><a href="inclusion_exclusion_principle.html#" id="contents-show" style="display:none">[показать]</a></p><div style="display:none"></div></div><h1> Принцип включений-исключений </h1><p>Принцип включений-исключений &mdash; это важный комбинаторный приём, позволяющий подсчитывать размер каких-либо множеств, или вычислять вероятность сложных событий.<p><p><h2 style="padding-top:40px;"> Формулировки принципа включений-исключений </h2><p><p><h3 style="padding-top:15px;"> Словесная формулировка </h3><p>Принцип включений-исключений выглядит следующим образом:<p>Чтобы посчитать размер объединения нескольких множеств, надо просуммировать размеры этих множеств <b>по отдельности</b>, затем вычесть размеры всех <b>попарных</b> пересечений этих множеств, прибавить обратно размеры пересечений всевозможных <b>троек</b> множеств, вычесть размеры пересечений <b>четвёрок</b>, и так далее, вплоть до пересечения <b>всех</b> множеств.<p><p><h3 style="padding-top:15px;"> Формулировка в терминах множеств </h3><p>В математической форме приведённая выше словесная формулировка выглядит следующим образом:<p><p class=formula><img class=tex src="../tex2png/cache/e696420a8116535a4b352a0b61e01453.png" alt=" \left| \bigcup_{i=1}^n A_i \right| = \sum_{i=1}^n[...]"></p><p>Её можно записать более компактно, через сумму по подмножествам. Обозначим через <img class=tex src="../tex2png/cache/fb8234db4e6ea317a7c2aef7a38775ba.png" alt="B"> множество, элементами которого являются <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i">. Тогда принцип включений-исключений принимает вид:<p><p class=formula><img class=tex src="../tex2png/cache/ec86fdd894a6ded309930d92a4f84115.png" alt=" \left| \bigcup_{i=1}^n A_i \right| = \sum_{C \sub[...]"></p><p>Эту формулу приписывают Муавру (Abraham de Moivre).<p><p><h3 style="padding-top:15px;"> Формулировка с помощью диаграмм Венна </h3><p>Пусть на диаграмме отмечены три фигуры <img class=tex src="../tex2png/cache/b5f17df636a8bd667d2f5c3404ed82e7.png" alt="A">, <img class=tex src="../tex2png/cache/fb8234db4e6ea317a7c2aef7a38775ba.png" alt="B"> и <img class=tex src="../tex2png/cache/5572481c8713abb69ad4011419e91fc7.png" alt="C">:<p><img src="inclusion_exclusion_1.png"><p>Тогда площадь объединения <img class=tex src="../tex2png/cache/b8fcb60b1387674c76a26ecaed83724a.png" alt="A \cup B \cup C"> равна сумме площадей <img class=tex src="../tex2png/cache/b5f17df636a8bd667d2f5c3404ed82e7.png" alt="A">, <img class=tex src="../tex2png/cache/fb8234db4e6ea317a7c2aef7a38775ba.png" alt="B"> и <img class=tex src="../tex2png/cache/5572481c8713abb69ad4011419e91fc7.png" alt="C"> за вычетом дважды покрытых площадей <img class=tex src="../tex2png/cache/11c68ccabc979c93e819864daab28321.png" alt="A \cap B">, <img class=tex src="../tex2png/cache/b811bcc1149e5660851967dd73a4244a.png" alt="A \cap C">, <img class=tex src="../tex2png/cache/d94a4dac54e5c8d4bfbd7579cdb113ff.png" alt="B \cap C">, но с прибавлением трижды покрытой площади <img class=tex src="../tex2png/cache/957067d0217942770b250ce452cafd9b.png" alt="A \cap B \cap C">:<p><p class=formula><img class=tex src="../tex2png/cache/6f95b39af202303960aedbf44d61ce8a.png" alt=" S(A \cup B \cup C) = S(A) ~ + ~ S(B) ~ + ~ S(C) ~[...]"></p><p>Аналогичным образом это обобщается и на объединение <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> фигур.<p><p><h3 style="padding-top:15px;"> Формулировка в терминах теории вероятностей </h3><p>Если <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i"> <img class=tex src="../tex2png/cache/c2c54841f66706685faa5312c5af0244.png" alt="(i = 1 \ldots n)"> &mdash; это события, <img class=tex src="../tex2png/cache/972aca823dcc059c29a3519521a3dad2.png" alt="{\cal P}(A_i)"> &mdash; их вероятности, то вероятность их объединения (т.е. того, что произойдёт хотя бы одно из этих событий) равна:<p><p class=formula><img class=tex src="../tex2png/cache/645e0aee5498b62735a33d4188f2c21c.png" alt=" \begin{eqnarray}
{\cal P} \left( \bigcup_{i=1}^n[...]"></p><p>Эту сумму также можно записать в виде суммы по подмножествам множества <img class=tex src="../tex2png/cache/fb8234db4e6ea317a7c2aef7a38775ba.png" alt="B">, элементами которого являются события <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i">:<p><p class=formula><img class=tex src="../tex2png/cache/bb8ce5abf08005a95817ac66243a99c9.png" alt=" {\cal P} \left( \bigcup_{i=1}^n A_i \right) = \su[...]"><p></p><p><h2 style="padding-top:40px;"> Доказательство принципа включений-исключений </h2><p>Для доказательства удобно пользоваться математической формулировкой в терминах теории множеств:<p><p class=formula><img class=tex src="../tex2png/cache/1574a45fe7fd862200e4144ac97d0192.png" alt=" \left| \bigcup_{i=1}^n A_i \right| = \sum_{C \sub[...]"></p><p>где <img class=tex src="../tex2png/cache/fb8234db4e6ea317a7c2aef7a38775ba.png" alt="B">, напомним, &mdash; это множество, состоящее из <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i">-ых.<p>Нам нужно доказать, что любой элемент, содержащийся хотя бы в одном из множеств <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i">, учтётся формулой ровно один раз. (Заметим, что остальные элементы, не содержащиеся ни в одном из <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i">, никак не могут быть учтены, поскольку отсутствуют в правой части формулы).<p>Рассмотрим произвольный элемент <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x">, содержащийся ровно в <img class=tex src="../tex2png/cache/8ceda01123621f3345ced346ee36db0f.png" alt="k \ge 1"> множествах <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i">. Покажем, что он посчитается формулой ровно один раз.<p>Заметим, что:<p><ul><p><li>в тех слагаемых, у которых <img class=tex src="../tex2png/cache/ff0ba3dff3603f519905b70bb68c88c9.png" alt="size(C) = 1">, элемент <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> учтётся ровно <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> раз, со знаком плюс;<p><li>в тех слагаемых, у которых <img class=tex src="../tex2png/cache/5aac9ee28495bc275d4d446fb07caa35.png" alt="size(C) = 2">, элемент <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> учтётся (со знаком минус) ровно <img class=tex src="../tex2png/cache/99eb1c3df10223934d04a6a73554300b.png" alt="C_k^2"> раз &mdash; потому что <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> посчитается только в тех слагаемых, которые соответствуют двум множествам из <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> множеств, содержащих <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x">;<p><li>в тех слагаемых, у которых <img class=tex src="../tex2png/cache/b15a366848d0759d96046a1de9711d35.png" alt="size(C) = 3">, элемент <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> учтётся ровно <img class=tex src="../tex2png/cache/7144759a8c8f9205f922ddafa2866531.png" alt="C_k^3"> раз, со знаком плюс;<p><li><img class=tex src="../tex2png/cache/267994e119a8959ca9fc503a1ebd7490.png" alt="\ldots"><p><li>в тех слагаемых, у которых <img class=tex src="../tex2png/cache/e0006ae94d9885a7adde8828694c1a56.png" alt="size(C) = k">, элемент <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> учтётся ровно <img class=tex src="../tex2png/cache/2698587b1d1f071485ff9146dc67f8c7.png" alt="C_k^k"> раз, со знаком <img class=tex src="../tex2png/cache/be0e5be4e2487a5699fcc4604d8d6ad0.png" alt="(-1)^{k-1}">;<p><li>в тех слагаемых, у которых <img class=tex src="../tex2png/cache/470a023081a98bf38bf1a803b15bf4d5.png" alt="size(C) > k">, элемент <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> учтётся ноль раз.<p></ul><p>Таким образом, нам надо посчитать такую сумму <a href="binomial_coeff.html">биномиальных коэффициентов</a>:<p><p class=formula><img class=tex src="../tex2png/cache/99ffbf625dd996a83712de29a8cc5cd9.png" alt=" T = C_k^1 - C_k^2 + C_k^3 - \ldots + (-1)^{i-1} \[...]"></p><p>Проще всего посчитать эту сумму, сравнив её с разложением в бином Ньютона выражения <img class=tex src="../tex2png/cache/99cb5d15a9ce0ac6f0c7d35565e2dbc0.png" alt="(1-x)^k">:<p><p class=formula><img class=tex src="../tex2png/cache/d7f2cd59a92544f845e30b21cd464d88.png" alt=" (1-x)^k = C_k^0 - C_k^1 \cdot x + C_k^2 \cdot x^2[...]"></p><p>Видно, что при <img class=tex src="../tex2png/cache/b137898897330f37670f24e31e9340dd.png" alt="x=1"> выражение <img class=tex src="../tex2png/cache/99cb5d15a9ce0ac6f0c7d35565e2dbc0.png" alt="(1-x)^k"> представляет собой не что иное, как <img class=tex src="../tex2png/cache/0701550acc48a66816be7c3bbe9aa2a9.png" alt="1 - T">. Следовательно, <img class=tex src="../tex2png/cache/85da0e3bd30b1dffb1f8eb2746f41fbf.png" alt="T = 1 - (1-1)^k = 1">, что и требовалось доказать.<p><p><h2 style="padding-top:40px;"> Применения при решении задач </h2><p>Принцип включений-исключений сложно хорошо понять без изучения примеров его применений.<p>Сначала мы рассмотрим три простые задачи "на бумажке", иллюстрирующие применение принципа, затем рассмотрим более практические задачи, которые трудно решить без использования принципа включений-исключений.<p>Особо следует отметить задачу "поиск числа путей", поскольку в ней демонстрируется, что принцип включений-исключений может иногда приводить к полиномиальным решениям, а не обязательно экспоненциальным.<p><p><h3 style="padding-top:15px;"> Простая задачка о перестановках </h3><p>Сколько есть перестановок чисел от <img class=tex src="../tex2png/cache/d796aaaffd5bff4144c8ac3509c1d33d.png" alt="0"> до <img class=tex src="../tex2png/cache/141aa12977eb90edab9130cae519bccf.png" alt="9"> таких, что первый элемент больше <img class=tex src="../tex2png/cache/1737ac55fdbc871d8c7d14245b749ccd.png" alt="1">, а последний &mdash; меньше <img class=tex src="../tex2png/cache/fa6a7da1482cae770cdfc2108255c1b8.png" alt="8">?<p>Посчитаем число "плохих" перестановок, т.е. таких, у которых первый элемент <img class=tex src="../tex2png/cache/b377390b983b51536621158e6cf14ba2.png" alt="\le 1"> и/или последний <img class=tex src="../tex2png/cache/47f15f62613b7020e6ee8b8d0bfc28d3.png" alt="\ge 8">.<p>Обозначим через <img class=tex src="../tex2png/cache/6c40947c41a939b41e0cfe6506c9e3c8.png" alt="X"> множество перестановок, у которых первый элемент <img class=tex src="../tex2png/cache/b377390b983b51536621158e6cf14ba2.png" alt="\le 1">, а через <img class=tex src="../tex2png/cache/2f103fbb20004cd7122d15d73c2acaf0.png" alt="Y"> &mdash; у которых последний элемент <img class=tex src="../tex2png/cache/47f15f62613b7020e6ee8b8d0bfc28d3.png" alt="\ge 8">. Тогда количество "плохих" перестановок по формуле включений-исключений равно:<p><p class=formula><img class=tex src="../tex2png/cache/222afae8dbc4c26218bba4d60616c975.png" alt=" |X| + |Y| - |X \cap Y|. "></p><p>Проведя несложные комбинаторные вычисления, получаем, что это равно:<p><p class=formula><img class=tex src="../tex2png/cache/da8b10994848bf3744f83f691f3cf9fa.png" alt=" 2 \cdot 9! + 2 \cdot 9! - 2 \cdot 2 \cdot 8! "></p><p>Отнимая это число от общего числа перестановок <img class=tex src="../tex2png/cache/24709b1f0ade7d1324c60bbe907497af.png" alt="10!">, мы получим ответ.<p><p><h3 style="padding-top:15px;"> Простая задачка о (0,1,2)-последовательностях </h3><p>Сколько существует последовательностей длины <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">, состоящих только из чисел <img class=tex src="../tex2png/cache/3dd6758a1a3045d8455c95b3ba701946.png" alt="0,1,2">, причём каждое число встречается хотя бы раз?<p>Снова перейдём к обратной задаче, т.е. будем считать число последовательностей, в которых не присутствует хотя бы одно из чисел.<p>Обозначим через <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i"> (<img class=tex src="../tex2png/cache/a5d79ddb1078644ca8c7c131d5dc8f63.png" alt="i = 0 \ldots 2">) множество последовательностей, в которых не встречается число <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">. Тогда по формуле включений-исключений число "плохих" последовательностей равно:<p><p class=formula><img class=tex src="../tex2png/cache/cf9302ef0ae566f3e29db122f2b922f1.png" alt=" |A_0| + |A_1| + |A_2| - |A_0 \cap A_1| - |A_0 \ca[...]"></p><p>Размеры каждого из <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i"> равны, очевидно, <img class=tex src="../tex2png/cache/f26be6eff0bc0813c49c4125743c6e55.png" alt="2^n"> (поскольку в таких последовательностях могут встречаться только два вида цифр). Мощности каждого попарного пересечения <img class=tex src="../tex2png/cache/663d0fa1eca6824569ff225acdaf13ab.png" alt="A_i \cap A_j"> равны <img class=tex src="../tex2png/cache/1737ac55fdbc871d8c7d14245b749ccd.png" alt="1"> (поскольку остаётся доступной только одна цифра). Наконец, мощность пересечения всех трёх множеств равна <img class=tex src="../tex2png/cache/d796aaaffd5bff4144c8ac3509c1d33d.png" alt="0"> (поскольку доступных цифр вообще не остаётся).<p>Вспоминая, что мы решали обратную задачу, получаем итоговый <b>ответ</b>:<p><p class=formula><img class=tex src="../tex2png/cache/99c0fe5e12daa0e3320b9181b7c864a8.png" alt=" 3^n - 3 \cdot 2^n + 3 \cdot 1 - 0. "><p></p><p><h3 style="padding-top:15px;"> Количество целочисленных решений уравнения </h3><p>Дано уравнение:<p><p class=formula><img class=tex src="../tex2png/cache/757b3e13097b1fccea9e5fc8b042983c.png" alt=" x_1 + x_2 + x_3 + x_4 + x_5 + x_6 = 20, "></p><p>где все <img class=tex src="../tex2png/cache/fda296868c223899d783d1fc6b9318d8.png" alt="0 \le x_i \le 8"> (где <img class=tex src="../tex2png/cache/ccfa01d64af7888b193ecb015163ca0d.png" alt="i = 1 \ldots 6">).<p>Требуется посчитать число решений этого уравнения.<p>Забудем сначала про ограничение <img class=tex src="../tex2png/cache/49b55efc1f7c102d996c2566c0d819c1.png" alt="x_i \le 8">, и просто посчитаем число неотрицательных решений этого уравнения. Это легко делается через <a href="binomial_coeff.html">биномиальные коэффициенты</a> &mdash; мы хотим разбить <img class=tex src="../tex2png/cache/5e7759304ea771e5b17cc15648bdae1f.png" alt="20"> элементов на <img class=tex src="../tex2png/cache/4865d5147ae3eb875ffc560f11594965.png" alt="6"> групп, т.е. распределить <img class=tex src="../tex2png/cache/ffd5c7a480888cf433d3b57d36bd7c52.png" alt="5"> "стенок", разделяющих группы, по <img class=tex src="../tex2png/cache/714792ad1bd0a7e1c581c9274327dcc3.png" alt="25"> местам:<p><p class=formula><img class=tex src="../tex2png/cache/847e01e12ae34c0ed82fca22a977b885.png" alt=" N_0 = C_{25}^5 "></p><p>Посчитаем теперь по формуле включений-исключений число "плохих" решений, т.е. таких решений уравнения, в которых один или более <img class=tex src="../tex2png/cache/bdf4742dd10f0eb4f2b7801e40b0e129.png" alt="x_i"> больше <img class=tex src="../tex2png/cache/141aa12977eb90edab9130cae519bccf.png" alt="9">.<p>Обозначим через <img class=tex src="../tex2png/cache/52475edaf8bceaddcd5bcedf63f73e80.png" alt="A_k"> (где <img class=tex src="../tex2png/cache/b853681ed2f344e902da712a25cd800b.png" alt="k = 1 \ldots 6">) множество таких решений уравнения, в которых <img class=tex src="../tex2png/cache/eb3f76d7002b4f23f0b402300209ac46.png" alt="x_k \ge 9">, а все остальные <img class=tex src="../tex2png/cache/a8f947bdba13d365354eb59a1580d684.png" alt="x_i \ge 0"> (для всех <img class=tex src="../tex2png/cache/e0982d94448fe632b16dc38a86b9ec22.png" alt="i \ne k">). Чтобы посчитать размер множества <img class=tex src="../tex2png/cache/52475edaf8bceaddcd5bcedf63f73e80.png" alt="A_k">, заметим, что у нас по сути та же комбинаторная задача, что решалась двумя абзацами выше, только теперь <img class=tex src="../tex2png/cache/141aa12977eb90edab9130cae519bccf.png" alt="9"> элементов исключены из рассмотрения и точно принадлежат первой группе. Таким образом:<p><p class=formula><img class=tex src="../tex2png/cache/cdb38f4362f71a5e5813486b719f0c59.png" alt=" | A_k | = C_{16}^5 "></p><p>Аналогично, мощность пересечения двух множеств <img class=tex src="../tex2png/cache/52475edaf8bceaddcd5bcedf63f73e80.png" alt="A_k"> и <img class=tex src="../tex2png/cache/015e5e292a6d566add693c33eb6cb3d7.png" alt="A_p"> равна числу:<p><p class=formula><img class=tex src="../tex2png/cache/a3e31cbc667c6ffb5239d579feff6f68.png" alt=" \left| A_k \cap A_p \right| = C_7^5 "></p><p>Мощность каждого пересечения трёх и более множеств равна нулю, поскольку <img class=tex src="../tex2png/cache/5e7759304ea771e5b17cc15648bdae1f.png" alt="20"> элементов не хватит на три и более переменных, больше либо равных <img class=tex src="../tex2png/cache/141aa12977eb90edab9130cae519bccf.png" alt="9">.<p>Объединяя всё это в формулу включений-исключений и учитывая, что мы решали обратную задачу, окончательно получаем <b>ответ</b>:<p><p class=formula><img class=tex src="../tex2png/cache/b9dd59d35e0ffb3d87655a205ef1efd6.png" alt=" C_{25}^5 - C_6^1 \cdot C_{16}^5 + C_6^2 \cdot C_7[...]"><p></p><p><h3 style="padding-top:15px;"> Количество взаимно простых чисел в заданном отрезке </h3><p>Пусть даны числа <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> и <img class=tex src="../tex2png/cache/d51b82f01bc38fe0d2e4a69ebec7c641.png" alt="r">. Требуется посчитать количество чисел в отрезке <img class=tex src="../tex2png/cache/cbbe446745deee8da70e67040c523d61.png" alt="[1; r]">, взаимно простых с <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">.<p>Сразу перейдём к обратной задаче &mdash; посчитаем количество не взаимно простых чисел.<p>Рассмотрим все простые делители числа <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">; обозначим их через <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i"> (<img class=tex src="../tex2png/cache/ce45baeaf3e1c4732cc9524411d4cac8.png" alt="i = 1 \ldots k">).<p>Сколько чисел в отрезке <img class=tex src="../tex2png/cache/e4a06f9ab811b62765e6bc1cb768d161.png" alt="[1;r]">, делящихся на <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i">? Их количество равно:<p><p class=formula><img class=tex src="../tex2png/cache/f80ff8ea9069fd3b81b7629e5bf8074e.png" alt=" \left\lfloor \frac{ r }{ p_i } \right\rfloor "></p><p>Однако если мы просто просуммируем эти числа, то получим неправильный ответ &mdash; некоторые числа будут просуммированы несколько раз (те, которые делятся сразу на несколько <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i">). Поэтому надо воспользоваться формулой включений-исключений.<p>Например, можно за <img class=tex src="../tex2png/cache/a631b6ee74bdfc6711813da7ca95a648.png" alt="2^k"> перебрать подмножество множества всех <img class=tex src="../tex2png/cache/b98bee3099688d9f0572adb2ffa3ff68.png" alt="p_i">-ых, посчитать их произведение, и прибавить или вычесть в формуле включений-исключений очередное слагаемое.<p>Итоговая <b>реализация</b> для подсчёта количества взаимно простых чисел:<p><pre class="notranslate cpp"><span class="kw4">int</span> solve <span class="br0">&#40;</span><span class="kw4">int</span> n, <span class="kw4">int</span> r<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> p<span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">2</span><span class="sy4">;</span> i<span class="sy2">*</span>i<span class="sy1">&lt;=</span>n<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>n <span class="sy2">%</span> i <span class="sy1">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			p.<span class="me1">push_back</span> <span class="br0">&#40;</span>i<span class="br0">&#41;</span><span class="sy4">;</span>
			<span class="kw1">while</span> <span class="br0">&#40;</span>n <span class="sy2">%</span> i <span class="sy1">==</span> <span class="nu0">0</span><span class="br0">&#41;</span>
				n <span class="sy2">/</span><span class="sy1">=</span> i<span class="sy4">;</span>
		<span class="br0">&#125;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>n <span class="sy1">&gt;</span> <span class="nu0">1</span><span class="br0">&#41;</span>
		p.<span class="me1">push_back</span> <span class="br0">&#40;</span>n<span class="br0">&#41;</span><span class="sy4">;</span>
&nbsp;
	<span class="kw4">int</span> sum <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> msk<span class="sy1">=</span><span class="nu0">1</span><span class="sy4">;</span> msk<span class="sy1">&lt;</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="sy1">&lt;&lt;</span>p.<span class="me1">size</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy4">;</span> <span class="sy2">++</span>msk<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw4">int</span> mult <span class="sy1">=</span> <span class="nu0">1</span>,
			bits <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span><span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span>p.<span class="me1">size</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
			<span class="kw1">if</span> <span class="br0">&#40;</span>msk <span class="sy3">&amp;</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="sy1">&lt;&lt;</span>i<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="sy2">++</span>bits<span class="sy4">;</span>
				mult <span class="sy2">*</span><span class="sy1">=</span> p<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
&nbsp;
		<span class="kw4">int</span> cur <span class="sy1">=</span> r <span class="sy2">/</span> mult<span class="sy4">;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>bits <span class="sy2">%</span> <span class="nu0">2</span> <span class="sy1">==</span> <span class="nu0">1</span><span class="br0">&#41;</span>
			sum <span class="sy2">+</span><span class="sy1">=</span> cur<span class="sy4">;</span>
		<span class="kw1">else</span>
			sum <span class="sy2">-</span><span class="sy1">=</span> cur<span class="sy4">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">return</span> r <span class="sy2">-</span> sum<span class="sy4">;</span>
<span class="br0">&#125;</span></pre><p>Асимптотика решения составляет <img class=tex src="../tex2png/cache/60208aa299c4789f19cb5dcf9463ba9a.png" alt="O (\sqrt{n})">.<p><p><h3 style="padding-top:15px;"> Количество чисел в заданном отрезке, кратных хотя бы одному из заданных чисел </h3><p>Даны <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> чисел <img class=tex src="../tex2png/cache/ef875bf5bad8370d4f3bbe3c740d3dd3.png" alt="a_i"> и число <img class=tex src="../tex2png/cache/d51b82f01bc38fe0d2e4a69ebec7c641.png" alt="r">. Требуется посчитать количество чисел в отрезке <img class=tex src="../tex2png/cache/cbbe446745deee8da70e67040c523d61.png" alt="[1; r]">, которые кратны хотя бы одному из <img class=tex src="../tex2png/cache/ef875bf5bad8370d4f3bbe3c740d3dd3.png" alt="a_i">.<p>Алгоритм решения практически совпадает с предыдущей задачей &mdash; делаем формулу включений-исключений над числами <img class=tex src="../tex2png/cache/ef875bf5bad8370d4f3bbe3c740d3dd3.png" alt="a_i">, т.е. каждое слагаемое в этой формуле &mdash; это количество чисел, делящихся на заданный поднабор чисел <img class=tex src="../tex2png/cache/ef875bf5bad8370d4f3bbe3c740d3dd3.png" alt="a_i"> (иными словами, делящихся на их <a href="euclid_algorithm.html">наименьшее общее кратное</a>).<p>Таким образом, решение сводится к тому, чтобы за <img class=tex src="../tex2png/cache/f26be6eff0bc0813c49c4125743c6e55.png" alt="2^n"> перебрать поднабор чисел, за <img class=tex src="../tex2png/cache/a156bb24e0dde4e6132938205f7fd6c6.png" alt="O(n \log r)"> операций найти их наименьшее общее кратное, и прибавить или вычесть из ответа очередное значение.<p><p><h3 style="padding-top:15px;"> Количество строк, удовлетворяющих заданному числу паттернов </h3><p>Дано <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> паттернов &mdash; строк одинаковой длины, состоящих только из букв и знаков вопроса. Также дано число <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k">. Требуется посчитать количество строк, удовлетворяющих ровно <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> паттернам либо, в другой постановке, как минимум <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> паттернам.<p>Заметим вначале, что мы можем <b>легко посчитать число строк</b>, удовлетворяющих сразу всем указанным паттернам. Для этого надо просто "пересечь" эти паттерны: посмотреть на первый символ (во всех ли паттернах на первой позиции стоит вопрос, или не во всех &mdash; тогда первый символ определён однозначно), на второй символ, и т.д.<p>Научимся теперь решать <b>первый вариант задачи</b>: когда искомые строки должны удовлетворять ровно <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> паттернам.<p>Для этого переберём и зафксируем конкретное подмножество <img class=tex src="../tex2png/cache/6c40947c41a939b41e0cfe6506c9e3c8.png" alt="X"> паттернов размера <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> &mdash; теперь мы должны посчитать количество строк, удовлетворяющих этому набору паттернов и только ему. Для этого воспользуемся формулой включений-исключений: мы суммируем по всем надмножествам множества <img class=tex src="../tex2png/cache/6c40947c41a939b41e0cfe6506c9e3c8.png" alt="X">, и либо прибавляем к текущему ответу, либо отнимаем от него количество строк, подходящих под текущее множество:<p><p class=formula><img class=tex src="../tex2png/cache/a75610f3aa3ea4f6c5a2076cdb953b31.png" alt=" ans(X) = \sum_{Y \supseteq X} (-1)^{|Y|-k} \cdot [...]"></p><p>где <img class=tex src="../tex2png/cache/8af77b51e31c01f292544087fd9d758e.png" alt="f(Y)"> обозначает количество строк, подходящих под набор паттернов <img class=tex src="../tex2png/cache/2f103fbb20004cd7122d15d73c2acaf0.png" alt="Y">.<p>Если мы просуммируем <img class=tex src="../tex2png/cache/b842c4ce57f80051c6637e7adfb7f992.png" alt="ans(X)"> по всем <img class=tex src="../tex2png/cache/6c40947c41a939b41e0cfe6506c9e3c8.png" alt="X">, то получим ответ:<p><p class=formula><img class=tex src="../tex2png/cache/32da461f2e7193c688ef7942a7fab0a9.png" alt=" ans = \sum_{X ~ : ~ |X| = k} ans(X). "></p><p>Однако тем самым мы получили решение за время порядка <img class=tex src="../tex2png/cache/7fb0c4005771e5d7e590a70c309d0b3d.png" alt="O(3^k \cdot k)">.<p>Решение можно ускорить, заметив, что в разных <img class=tex src="../tex2png/cache/b842c4ce57f80051c6637e7adfb7f992.png" alt="ans(X)"> суммирование зачастую ведётся по одним и тем же множествам <img class=tex src="../tex2png/cache/2f103fbb20004cd7122d15d73c2acaf0.png" alt="Y">.<p>Перевернём формулу включений-исключений и будем вести суммирование по <img class=tex src="../tex2png/cache/2f103fbb20004cd7122d15d73c2acaf0.png" alt="Y">. Тогда легко понять, что множество <img class=tex src="../tex2png/cache/2f103fbb20004cd7122d15d73c2acaf0.png" alt="Y"> учтётся в <img class=tex src="../tex2png/cache/692a04895a43b36360bda1242b9aef25.png" alt="C_{|Y|}^k"> формулах включений-исключений, везде с одним и тем же знаком <img class=tex src="../tex2png/cache/287a265f55d4088fe6c2d5fa5e51238d.png" alt="(-1)^{|Y|-k}">:<p><p class=formula><img class=tex src="../tex2png/cache/c7fdf3993a8d3a8448492b50ab400ee8.png" alt=" ans = \sum_{Y ~ : ~ |Y| \ge k} (-1)^{|Y|-k} \cdot[...]"></p><p>Решение получилось с асимптотикой <img class=tex src="../tex2png/cache/335e2d51d76d202b9e4ecbfc48848860.png" alt="O(2^k \cdot k)">.<p>Перейдём теперь ко <b>второму варианту задачи</b>: когда искомые строки должны удовлетворять как минимум <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> паттернам.<p>Понятно, мы можем просто воспользоваться решением первого варианта задачи и просуммировать ответы от <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> до <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">. Однако можно заметить, что все рассуждения по-прежнему будут верны, только в этом варианте задачи сумма по <img class=tex src="../tex2png/cache/6c40947c41a939b41e0cfe6506c9e3c8.png" alt="X"> идёт не только по тем множествам, размер которых равен <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k">, а по всем множествам с размером <img class=tex src="../tex2png/cache/9d2dac01a5ebeff005f7464d36969397.png" alt="\ge k">.<p>Таким образом, в итоговой формуле перед <img class=tex src="../tex2png/cache/8af77b51e31c01f292544087fd9d758e.png" alt="f(Y)"> будет стоять другой коэффициент: не один биномиальный коэффициент с каким-то знаком, а их сумма:<p><p class=formula><img class=tex src="../tex2png/cache/9164cb87882544d9276d05be38ef3e68.png" alt=" (-1)^{|Y|-k} \cdot C_{|Y|}^k ~~ + ~~ (-1)^{|Y|-k-[...]"></p><p>Заглянув в Грэхема (<a href="../bookz/files/graham.djvu">Грэхем, Кнут, Паташник. <b>"Конкретная математика"</b> [1998]</a> ), мы видим такую известную формулу для <a href="binomial_coeff.html">биномиальных коэффициентов</a>:<p><p class=formula><img class=tex src="../tex2png/cache/002e825cb580b5afed1ce62deeefd3af.png" alt=" \sum_{k=0}^m (-1)^k \cdot C_n^k = (-1)^m \cdot C_[...]"></p><p>Применяя её здесь, получаем, что вся эта сумма биномиальных коэффициентов сворачивается в:<p><p class=formula><img class=tex src="../tex2png/cache/f0e536b9d9d8c07e086ae864dff98fe5.png" alt=" (-1)^{|Y|-k} \cdot C_{|Y|-1}^{|Y|-k}. "></p><p>Таким образом, для этого варианта задачи мы также получили решение с асимптотикой <img class=tex src="../tex2png/cache/335e2d51d76d202b9e4ecbfc48848860.png" alt="O(2^k \cdot k)">:<p><p class=formula><img class=tex src="../tex2png/cache/bdcaf0fc8679ec8f90b00393def2f67f.png" alt=" ans = \sum_{Y ~ : ~ |Y| \ge k} (-1)^{|Y|-k} \cdot[...]"><p></p><p><h3 style="padding-top:15px;"> Количество путей </h3><p>Есть поле <img class=tex src="../tex2png/cache/ed0e13f7024ff254a4fccd689fe21ad3.png" alt="n \times m">, некоторые <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> клеток которого &mdash; непроходимые стенки. На поле в клетке <img class=tex src="../tex2png/cache/9ad54f612d8142111f513e21ae0a2830.png" alt="(1,1)"> (левая нижняя клетка) изначально находится робот. Робот может двигаться только вправо или вверх, и в итоге он должен попасть в клетку <img class=tex src="../tex2png/cache/00ee56d26fde8408a67d3be82336f527.png" alt="(n,m)">, избежав все препятствия. Требуется посчитать число путей, которыми он может это сделать.<p>Предполагаем, что размеры <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> и <img class=tex src="../tex2png/cache/4f70748eaed5e0c2c70d7e899166ee1d.png" alt="m"> очень большие (скажем, до <img class=tex src="../tex2png/cache/444ed8a79d12976910378f0f39064696.png" alt="10^9">), а количество <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> &mdash; небольшое (порядка <img class=tex src="../tex2png/cache/42eebf03554591becb9bdde682ba1fbf.png" alt="100">).<p>Для решения сразу в целях удобства <b>отсортируем</b> препятствия в том порядке, в каком мы можем их обойти: т.е., например, по координате <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x">, а при равенстве &mdash; по координате <img class=tex src="../tex2png/cache/e1fbf2db960f0155bd590871a486e78c.png" alt="y">.<p>Также сразу научимся решать задачу без препятствий: т.е. научимся считать число способов дойти от одной клетки до другой. Если по одной координате нам надо пройти <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> клеток, а по другой &mdash; <img class=tex src="../tex2png/cache/e1fbf2db960f0155bd590871a486e78c.png" alt="y"> клеток, то из несложной комбинаторики мы получаем такую формулу через <a href="binomial_coeff.html">биномиальные коэффициенты</a>:<p><p class=formula><img class=tex src="../tex2png/cache/94e4cb58a5728113c1a06b1631ba7b96.png" alt=" C_{x+y}^{x} "></p><p>Теперь чтобы посчитать число способов дойти от одной клетки до другой, избежав всех препятствий, можно воспользоваться <b>формулой включений-исключений</b>: посчитаем число способов дойти, наступив хотя бы на одно препятствие.<p>Для этого можно, например, перебрать подмножество тех препятствий, на которые мы точно наступим, посчитать число способов сделать это (просто перемножив число способов дойти от стартовой клетки до первого из выбранных препятствий, от первого препятствия до второго, и так далее), и затем прибавить или отнять это число от ответа, в соответствии со стандартной формулой включений-исключений.<p>Однако это снова будет неполиномиальное решение &mdash; за асимптотику <img class=tex src="../tex2png/cache/e936a40958e43323a2fc4e6485cbe164.png" alt="O (2^k k)">. Покажем, как получить <b>полиномиальное решение</b>.<p>Решать будем <b>динамическим программированием</b>: научимся вычислять числа <img class=tex src="../tex2png/cache/a18f11689b09b23faa10c78d6b244cf8.png" alt="d[i][j]"> &mdash; число способов дойти от <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">-ой точки до <img class=tex src="../tex2png/cache/f2761432c5377ee4ded848884be6d407.png" alt="j">-ой, не наступив при этом ни на одно препятствие (кроме самих <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> и <img class=tex src="../tex2png/cache/f2761432c5377ee4ded848884be6d407.png" alt="j">, естественно). Всего у нас будет <img class=tex src="../tex2png/cache/fc0ba147e6448702aec70ee6ec529a6f.png" alt="k+2"> точки, поскольку к препятствиям добавляются стартовая и конечная клетки.<p>Если мы на секунду забудем про все препятствия и просто посчитаем число путей из клетки <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> в клетку <img class=tex src="../tex2png/cache/f2761432c5377ee4ded848884be6d407.png" alt="j">, то тем самым мы учтём некоторые "плохие" пути, проходящие через препятствия. Научимся считать количество этих "плохих" путей. Переберём первое из препятствий <img class=tex src="../tex2png/cache/feea1196596436ba1623a15c43ce0674.png" alt="i < t < j">, на которое мы наступим, тогда количество путей будет равно <img class=tex src="../tex2png/cache/00fc1505d13050d06855542ec55e219d.png" alt="d[i][t]">, умноженному на число произвольных путей из <img class=tex src="../tex2png/cache/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> в <img class=tex src="../tex2png/cache/f2761432c5377ee4ded848884be6d407.png" alt="j">. Просуммировав это по всем <img class=tex src="../tex2png/cache/668c0ed766381807a81b9a534a4a70ce.png" alt="t">, мы посчитаем количество "плохих" путей.<p>Таким образом, значение <img class=tex src="../tex2png/cache/a18f11689b09b23faa10c78d6b244cf8.png" alt="d[i][j]"> мы научились считать за время <img class=tex src="../tex2png/cache/ac686865eeed9866e9f70fcbc1e9b6e5.png" alt="O(k)">. Следовательно, решение всей задачи имеет асимптотику <img class=tex src="../tex2png/cache/c89122c987e30c62ea95ad2c3af1d6f3.png" alt="O(k^3)">.<p><p><h3 style="padding-top:15px;"> Число взаимно простых четвёрок </h3><p>Дано <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> чисел: <img class=tex src="../tex2png/cache/6746a24b8742fb7b6e4b25bf190cdea4.png" alt="a_1, a_2, \ldots, a_n">. Требуется посчитать количество способов выбрать из них четыре числа так, что их совокупный наибольший общий делитель равен единице.<p>Будем решать обратную задачу &mdash; посчитаем число "плохих" четвёрок, т.е. таких четвёрок, в которых все числа делятся на число <img class=tex src="../tex2png/cache/37a977017f6b5af9957bf42d1423a502.png" alt="d > 1">.<p>Воспользуемся формулой включений-исключений, суммируя количество четвёрок, делящихся на делитель <img class=tex src="../tex2png/cache/30956e25578e9cb8f03bd9d36433020c.png" alt="d"> (но, возможно, делящихся и на больший делитель):<p><p class=formula><img class=tex src="../tex2png/cache/8a321b2b3e2559c7431783b1a6a198b6.png" alt=" ans = \sum_{d \ge 2} (-1)^{deg(d)-1} \cdot f(d), "></p><p>где <img class=tex src="../tex2png/cache/0e38081833e1b3a5f0a658559c5d3a1a.png" alt="deg(d)"> &mdash; это количество простых в факторизации числа <img class=tex src="../tex2png/cache/30956e25578e9cb8f03bd9d36433020c.png" alt="d">, <img class=tex src="../tex2png/cache/73e725a0475e487bba893e78885a8886.png" alt="f(d)"> &mdash; количество четвёрок, делящихся на <img class=tex src="../tex2png/cache/30956e25578e9cb8f03bd9d36433020c.png" alt="d">.<p>Чтобы посчитать функцию <img class=tex src="../tex2png/cache/73e725a0475e487bba893e78885a8886.png" alt="f(d)">, надо просто посчитать количество чисел, кратных <img class=tex src="../tex2png/cache/30956e25578e9cb8f03bd9d36433020c.png" alt="d">, и <a href="binomial_coeff.html">биномиальным коэффициентом</a> посчитать число способов выбрать из них четвёрку.<p>Таким образом, с помощью формулы включений-исключений мы суммируем количество четвёрок, делящихся на простые числа, затем отнимаем число четвёрок, делящихся на произведение двух простых, прибавляем четвёрки, делящиеся на три простых, и т.д.<p><p><h3 style="padding-top:15px;"> Число гармонических троек </h3><p>Дано число <img class=tex src="../tex2png/cache/74e6878028e83a0aedbdf342a8100445.png" alt="n \le 10^6">. Требуется посчитать число таких троек чисел <img class=tex src="../tex2png/cache/309d78d0e6b6c77bc5e39891c95b3aae.png" alt="2 \le a < b < c \le n">, что они являются гармоническими тройками, т.е.:<p><ul><p><li>либо <img class=tex src="../tex2png/cache/89d21dacb8b79f22b0fbce3d3395d3d9.png" alt="{\rm gcd}(a,b) = {\rm gcd}(a,c) = {\rm gcd}(b,c) = 1">,<li>либо <img class=tex src="../tex2png/cache/4892fef848fec836d43d30c313890b50.png" alt="{\rm gcd}(a,b) > 1">, <img class=tex src="../tex2png/cache/c2be125ab8ff9416d384af834ac4d608.png" alt="{\rm gcd}(a,c) > 1">, <img class=tex src="../tex2png/cache/2f4d9f2defeec96196ff625ace08d551.png" alt="{\rm gcd}(b,c) > 1">.<p></ul><p>Во-первых, сразу перейдём к обратной задаче &mdash; т.е. посчитаем число негармонических троек.<p>Во-вторых, заметим, что в любой негармонической тройке ровно два её числа находятся в такой ситуации, что это число взаимно просто с одним числом тройки и не взаимно просто с другим числом тройки.<p>Таким образом, количество негармонических троек равно сумме по всем числам от <img class=tex src="../tex2png/cache/1f68ec6d6ed94148fc6fb5efafc8a688.png" alt="2"> до <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> произведений количества взаимно простых с текущим числом чисел на количество не взаимно простых чисел.<p>Теперь всё, что нам осталось для решения задачи &mdash; это научиться считать для каждого числа в отрезке <img class=tex src="../tex2png/cache/844775997e9571036d4f38fb520ee6e8.png" alt="[2;n]"> количество чисел, взаимно простых (или не взаимно простых) с ним. Хотя эта задача уже рассматривалась нами выше, описанное выше решение не подходит здесь &mdash; оно потребует факторизации каждого из чисел от <img class=tex src="../tex2png/cache/1f68ec6d6ed94148fc6fb5efafc8a688.png" alt="2"> до <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">, и затем перебора всевозможных произведений простых чисел из факторизации.<p>Поэтому нам понадобится более быстрое решение, которое подсчитывает ответы для всех чисел из отрезка <img class=tex src="../tex2png/cache/844775997e9571036d4f38fb520ee6e8.png" alt="[2;n]"> сразу.<p>Для этого можно реализовать такую <b>модификацию решета Эратосфена</b>:<p><ul><p><li>Во-первых, нам надо найти все числа в отрезке <img class=tex src="../tex2png/cache/844775997e9571036d4f38fb520ee6e8.png" alt="[2;n]">, в факторизации которых никакое простое не входит дважды. Кроме того, для формулы включений-исключений нам потребуется знать, сколько простых содержит факторизация каждого такого числа.<p>Для этого нам надо завести массивы <img class=tex src="../tex2png/cache/d371fe7fd13b0d8c1a9a5a1b4a8be1ae.png" alt="deg[]">, хранящие для каждого числа количество простых в его факторизации, и <img class=tex src="../tex2png/cache/30fdf40e66a148f515480b70d6201f55.png" alt="good[]"> &mdash; содержащий для каждого числа <img class=tex src="../tex2png/cache/b5bc0e4f62b03a6845c99fb75ef614c3.png" alt="true"> или <img class=tex src="../tex2png/cache/988fdf965f9fdcef08a01d4587277022.png" alt="false"> &mdash; все простые входят в него в степени <img class=tex src="../tex2png/cache/b377390b983b51536621158e6cf14ba2.png" alt="\le 1"> или нет.<p>После этого во время решета Эратосфена при обработке очередного простого числа мы пройдёмся по всем числам, кратным текущему числу, и увеличим <img class=tex src="../tex2png/cache/d371fe7fd13b0d8c1a9a5a1b4a8be1ae.png" alt="deg[]"> у них, а у всех чисел, кратных квадрату от текущего простого &mdash; поставим <img class=tex src="../tex2png/cache/1a94163d09aec53db8aaab32cb2285b2.png" alt="good = false">.<p><li>Во-вторых, нам надо посчитать ответ для всех чисел от <img class=tex src="../tex2png/cache/1f68ec6d6ed94148fc6fb5efafc8a688.png" alt="2"> до <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">, т.е. массив <img class=tex src="../tex2png/cache/d5c17179cdaf271a459893d92005bf78.png" alt="cnt[]"> &mdash; количество чисел, не взаимно простых с данным.<p>Для этого вспомним, как работает формула включений-исключений &mdash; здесь фактически мы реализуем её же, но с перевёрнутой логикой: мы словно перебираем слагаемое и смотрим, в какие формулы включений-исключений для каких чисел это слагаемое входит.<p>Итак, пусть у нас есть число <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">, для которого <img class=tex src="../tex2png/cache/c36b38fdcaccc399541bfbc5f1dd1f9b.png" alt="good[]=true">, т.е. это число, участвующее в формуле включений-исключений. Переберём все числа, кратные <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">, и к ответу <img class=tex src="../tex2png/cache/d5c17179cdaf271a459893d92005bf78.png" alt="cnt[]"> каждого из таких чисел мы должны прибавить или вычесть величину <img class=tex src="../tex2png/cache/340ff6d98574d8ac0ea53397270a1098.png" alt="\lfloor N/i \rfloor">. Знак &mdash; прибавление или вычитание &mdash; зависит от <img class=tex src="../tex2png/cache/c0ff09804666cfc13292e52da3aceabd.png" alt="deg[i]">: если <img class=tex src="../tex2png/cache/c0ff09804666cfc13292e52da3aceabd.png" alt="deg[i]"> нечётна, то надо прибавлять, иначе вычитать.<p></ul><p><b>Реализация</b>:<p><pre class="notranslate cpp"><span class="kw4">int</span> n<span class="sy4">;</span>
<span class="kw4">bool</span> good<span class="br0">&#91;</span>MAXN<span class="br0">&#93;</span><span class="sy4">;</span>
<span class="kw4">int</span> deg<span class="br0">&#91;</span>MAXN<span class="br0">&#93;</span>, cnt<span class="br0">&#91;</span>MAXN<span class="br0">&#93;</span><span class="sy4">;</span>
&nbsp;
<span class="kw4">long</span> <span class="kw4">long</span> solve<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw3">memset</span> <span class="br0">&#40;</span>good, <span class="nu0">1</span>, <span class="kw3">sizeof</span> good<span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw3">memset</span> <span class="br0">&#40;</span>deg, <span class="nu0">0</span>, <span class="kw3">sizeof</span> deg<span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw3">memset</span> <span class="br0">&#40;</span>cnt, <span class="nu0">0</span>, <span class="kw3">sizeof</span> cnt<span class="br0">&#41;</span><span class="sy4">;</span>
&nbsp;
	<span class="kw4">long</span> <span class="kw4">long</span> ans_bad <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">2</span><span class="sy4">;</span> i<span class="sy1">&lt;=</span>n<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>good<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw1">if</span> <span class="br0">&#40;</span>deg<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">==</span> <span class="nu0">0</span><span class="br0">&#41;</span>  deg<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">=</span> <span class="nu0">1</span><span class="sy4">;</span>
			<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> j<span class="sy1">=</span><span class="nu0">1</span><span class="sy4">;</span> i<span class="sy2">*</span>j<span class="sy1">&lt;=</span>n<span class="sy4">;</span> <span class="sy2">++</span>j<span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span>j <span class="sy1">&gt;</span> <span class="nu0">1</span> <span class="sy3">&amp;&amp;</span> deg<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">==</span> <span class="nu0">1</span><span class="br0">&#41;</span>
					<span class="kw1">if</span> <span class="br0">&#40;</span>j <span class="sy2">%</span> i <span class="sy1">==</span> <span class="nu0">0</span><span class="br0">&#41;</span>
						good<span class="br0">&#91;</span>i<span class="sy2">*</span>j<span class="br0">&#93;</span> <span class="sy1">=</span> <span class="kw2">false</span><span class="sy4">;</span>
					<span class="kw1">else</span>
						<span class="sy2">++</span>deg<span class="br0">&#91;</span>i<span class="sy2">*</span>j<span class="br0">&#93;</span><span class="sy4">;</span>
				cnt<span class="br0">&#91;</span>i<span class="sy2">*</span>j<span class="br0">&#93;</span> <span class="sy2">+</span><span class="sy1">=</span> <span class="br0">&#40;</span>n <span class="sy2">/</span> i<span class="br0">&#41;</span> <span class="sy2">*</span> <span class="br0">&#40;</span>deg<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy2">%</span><span class="nu19">2</span><span class="sy1">==</span><span class="nu0">1</span> <span class="sy4">?</span> <span class="sy2">+</span><span class="nu0">1</span> <span class="sy4">:</span> <span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy4">;</span>
			<span class="br0">&#125;</span>
		<span class="br0">&#125;</span>
		ans_bad <span class="sy2">+</span><span class="sy1">=</span> <span class="br0">&#40;</span>cnt<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy2">-</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy2">*</span> 1ll <span class="sy2">*</span> <span class="br0">&#40;</span>n<span class="sy2">-</span><span class="nu0">1</span> <span class="sy2">-</span> cnt<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">return</span> <span class="br0">&#40;</span>n<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy2">*</span> 1ll <span class="sy2">*</span> <span class="br0">&#40;</span>n<span class="sy2">-</span><span class="nu0">2</span><span class="br0">&#41;</span> <span class="sy2">*</span> <span class="br0">&#40;</span>n<span class="sy2">-</span><span class="nu0">3</span><span class="br0">&#41;</span> <span class="sy2">/</span> <span class="nu0">6</span> <span class="sy2">-</span> ans_bad <span class="sy2">/</span> <span class="nu0">2</span><span class="sy4">;</span>
<span class="br0">&#125;</span></pre><p>Асимптотика такого решения составляет <img class=tex src="../tex2png/cache/65dae66ac82f684c5b24e464a8ca3610.png" alt="O (n \log n)">, поскольку почти для каждого числа <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> оно совершает примерно <img class=tex src="../tex2png/cache/5e5d705b9ea3dd25f6dd5d22fbb6ae9d.png" alt="n/i"> итераций вложенного цикла.<p><p><h3 style="padding-top:15px;"> Число перестановок без неподвижных точек </h3><p>Докажем, что число перестановок длины <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> без неподвижных точек равно следующему числу:<p><p class=formula><img class=tex src="../tex2png/cache/a53f6e69914d9a937bc0c3e72906f6d0.png" alt=" n! - C_n^1 \cdot (n-1)! + C_n^2 \cdot (n-2)! - C_[...]"></p><p>и приблизительно равно числу:<p><p class=formula><img class=tex src="../tex2png/cache/18ffcb43e2646f75f7cff8ba22b45938.png" alt=" \frac{ n! }{ e } "></p><p>(более того, если округлить это выражение к ближайшему целому &mdash; то получится в точности число перестановок без неподвижных точек)<p>Обозначим через <img class=tex src="../tex2png/cache/52475edaf8bceaddcd5bcedf63f73e80.png" alt="A_k"> множество перестановок длины <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> с неподвижной точкой в позиции <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> (<img class=tex src="../tex2png/cache/e97da6bafa3aeb5615fd72f4221245ca.png" alt="1 \le k \le n">).<p>Воспользуемся теперь формулой включений-исключений, чтобы посчитать число перестановок хотя бы с одной неподвижной точкой. Для этого нам надо научиться считать размеры множеств-пересечений <img class=tex src="../tex2png/cache/ecd1f057d6ceb5ed438e560f05b03792.png" alt="A_i">, они выглядят следующим образом:<p><p class=formula><img class=tex src="../tex2png/cache/9dad6e1702deffc228a8b13c2daf51d6.png" alt=" \left| A_p \right| = (n-1)! ~, "><br><img class=tex src="../tex2png/cache/a55f5698e1945e73ad01819ada6c958b.png" alt=" \left| A_p \cap A_q \right| = (n-2)! ~, "><br><img class=tex src="../tex2png/cache/90dcce063ccdb778e8e5c85855b8c8a1.png" alt=" \left| A_p \cap A_q \cap A_r \right| = (n-3)! ~, "><br><img class=tex src="../tex2png/cache/0cd284d67610b3e6ab1651ef01610e73.png" alt=" \ldots ~, "></p><p>поскольку если мы знаем, что число неподвижных точек равно <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x">, то тем самым мы знаем позицию <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> элементов перестановки, а все остальные <img class=tex src="../tex2png/cache/409090d19629d28ab15563b05d33c64d.png" alt="(n-x)"> элементов могут стоять где угодно.<p>Подставляя это в формулу включений-исключений и учитывая, что число способов выбрать подмножество размера <img class=tex src="../tex2png/cache/4a9252cee23f1a80a4e03256ef62d733.png" alt="x"> из <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">-элементного множества равно <img class=tex src="../tex2png/cache/efa6b7d0253437184649fa8c7d986f6c.png" alt="C_n^x">, получаем формулу для числа перестановок хотя бы с одной неподвижной точкой:<p><p class=formula><img class=tex src="../tex2png/cache/e9fb4486c356cc70561a57a4c4d18c58.png" alt=" C_n^1 \cdot (n-1)! - C_n^2 \cdot (n-2)! + C_n^3 \[...]"></p><p>Тогда число перестановок без неподвижных точек равно:<p><p class=formula><img class=tex src="../tex2png/cache/a53f6e69914d9a937bc0c3e72906f6d0.png" alt=" n! - C_n^1 \cdot (n-1)! + C_n^2 \cdot (n-2)! - C_[...]"></p><p>Упрощая это выражение, получаем <b>точное и приблизительное выражения для количества перестановок без неподвижных точек</b>:<p><p class=formula><img class=tex src="../tex2png/cache/f2586f8be08c6c5300e86c326074341e.png" alt=" n! \left( 1 - \frac{1}{1!} + \frac{1}{2!} - \frac[...]"></p><p>(поскольку сумма в скобках &mdash; это первые <img class=tex src="../tex2png/cache/a7f8de3dd9b0da0eb8ed96689169566e.png" alt="n+1"> членов разложения в ряд Тейлора <img class=tex src="../tex2png/cache/ca0ab31db3f57097d2d68b68b8fe04a7.png" alt="e^{-1}">)<p>В заключение стоит отметить, что аналогичным образом решается задача, когда требуется, чтобы неподвижных точек не было среди <img class=tex src="../tex2png/cache/4f70748eaed5e0c2c70d7e899166ee1d.png" alt="m"> первых элементов перестановок (а не среди всех, как мы только что решали). Формула получится такая, как приведённая выше точная формула, только в ней сумма будет идти до <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k">, а не до <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">.<p><p><p><h2 style="padding-top:40px;"> Задачи в online judges </h2><p>Список задач, которые можно решить, используя принцип включений-исключений:<p><ul><p><li><a href="http://uva.onlinejudge.org/index.php?option=onlinejudge&page=show_problem&problem=1266">UVA #10325 <b>"The Lottery"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: низкая]</a><p><li><a href="http://uva.onlinejudge.org/index.php?option=com_onlinejudge&Itemid=8&page=show_problem&problem=2906">UVA #11806 <b>"Cheerleaders"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: низкая]</a><p><li><a href="http://www.topcoder.com/stat?c=problem_statement&pm=10875">TopCoder SRM 477 <b>"CarelessSecretary"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: низкая]</a><p><li><a href="http://community.topcoder.com/stat?c=problem_statement&pm=6658&rd=10068">TopCoder TCHS 16 <b>"Divisibility"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: низкая]</a><p><li><a href="http://www.spoj.pl/problems/NGM2/">SPOJ #6285 NGM2 <b>"Another Game With Numbers"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: низкая]</a><p><li><a href="http://community.topcoder.com/stat?c=problem_statement&pm=8470">TopCoder SRM 382 <b>"CharmingTicketsEasy"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p><li><a href="http://www.topcoder.com/stat?c=problem_statement&pm=8307">TopCoder SRM 390 <b>"SetOfPatterns"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p><li><a href="http://community.topcoder.com/stat?c=problem_statement&pm=2013">TopCoder SRM 176 <b>"Deranged"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p><li><a href="http://community.topcoder.com/stat?c=problem_statement&pm=10702&rd=14144&rm=303184&cr=22697599">TopCoder SRM 457 <b>"TheHexagonsDivOne"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p><li><a href="http://www.spoj.pl/problems/MSKYCODE/">SPOJ #4191 MSKYCODE <b>"Sky Code"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p><li><a href="http://www.spoj.pl/problems/SQFREE/">SPOJ #4168 SQFREE <b>"Square-free integers"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p><li><a href="http://www.codechef.com/JAN11/problems/COUNTREL/">CodeChef <b>"Count Relations"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p></ul><p><p><p><h2 style="padding-top:40px;"> Литература </h2><p><ul><p><li><a href="http://faculty.wheelock.edu/dborkovitz/articles/ngm6.htm">Debra K. Borkovitz. <b>"Derangements and the Inclusion-Exclusion Principle"</b></a><p></ul><p><p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr><p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'e-maxx';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script></td></tr></table></body></html>