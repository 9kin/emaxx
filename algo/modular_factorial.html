<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>MAXimal :: algo :: Вычисление факториала по модулю</title><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><meta name="author" lang="ru" content="e-maxx" /><meta name="description" content="Алгоритмы, олимпиадное программирование, математика" /><meta name="keywords" content="алгоритмы программирование" /><meta name="google-site-verification" content="Pnjjj2XuxB0CTiqgDDvkp79bfSeDQ8Vw57iNeDJZkSc" /><link rel="stylesheet" type="text/css" href="../data/style.css"><script type="text/javascript" src="../data/jquery.js"></script><script type="text/javascript" src="../data/page-contents.js"></script><link rel="stylesheet" type="text/css" href="../geshi/geshi.css"><!--[if IE]><style>.menu a, .menu a:hover { width: 100%; }</style><![endif]--></head><body><table class=main cellpadding=0 cellspacing=0><tr><td class=title colspan=2><p>MAXimal</p></td></tr><tr><td class=menu><ul><li><a href="../index.php.html" >home</a></li><li><a href="index.html" class=current>algo</a></li><li><a href="../bookz/index.html" >bookz</a></li><li><a href="../forum/index.html" >forum</a></li><li><a href="../about.php.html" >about</a></li></ul></td><td class=content><p class=algoinfo>добавлено: 9 Sep 2008 19:28<br>редактировано: 20 Sep 2010 18:45</p><div id="contents-table"><p id="contents-table-title">Содержание <a href="modular_factorial.html#" id="contents-hide">[скрыть]</a><a href="modular_factorial.html#" id="contents-show" style="display:none">[показать]</a></p><div style="display:none"></div></div><h1>Вычисление факториала по модулю</h1><p>В некоторых случаях необходимо считать по некоторому простому модулю <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p"> сложные формулы, которые в том числе могут содержать факториалы. Здесь мы рассмотрим случай, когда модуль <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p"> сравнительно мал. Понятно, что эта задача имеет смысл только в том случае, когда факториалы входят и в числитель, и в знаменатель дробей. Действительно, факториал <img class=tex src="../tex2png/cache/3d8dea8bb50ef0cfed25e2d1582395c1.png" alt="p!"> и все последующие обращаются в ноль по модулю <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p">, однако в дробях все множители, содержащие <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p">, могут сократиться, и полученное выражение уже будет отлично от нуля по модулю <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p">.<p>Таким образом, формально <b>задача</b> такая. Требуется вычислить <img class=tex src="../tex2png/cache/7256a61e63bdcff610d0e712a6b2a485.png" alt="n!"> по простому модулю <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p">, при этом не учитывая все кратные <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p"> множители, входящие в факториал. Научившись эффективно вычислять такой факториал, мы сможем быстро вычислять значение различных комбинаторных формул (например, <a href="binomial_coeff.html">Биномиальные коэффициенты</a>).<p><p><h2 style="padding-top:40px;">Алгоритм</h2><p>Выпишем этот "модифицированный" факториал в явном виде:<p><p class=formula><img class=tex src="../tex2png/cache/9fcf4796fd83fd3ff1830c598aaf239a.png" alt=" n!_{\%p} = "><br><img class=tex src="../tex2png/cache/296b123a78bc168a7d7fab6aa98fd927.png" alt=" = 1 \cdot 2 \cdot 3 \cdot \ldots \cdot (p-2) \cdo[...]"><br><img class=tex src="../tex2png/cache/774a047bc2ce29c9c6f429b93e290015.png" alt=" \cdot (p^2-1) \cdot \underbrace{1}_{p^2} \cdot (p[...]"><br><img class=tex src="../tex2png/cache/0bcaed0449badc1e040fb3a9a96a16c9.png" alt=" = 1 \cdot 2 \cdot 3 \cdot \ldots \cdot (p-2) \cdo[...]"><br><img class=tex src="../tex2png/cache/7fa91feca02eac37349529244026ce6f.png" alt=" \cdot 1 \cdot 2 \cdot \ldots \cdot (n\%p) \pmod p[...]"></p><p>При такой записи видно, что "модифицированный" факториал распадается на несколько блоков длины <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p"> (последний блок, возможно, короче), которые все одинаковы, за исключением последнего элемента:<p><p class=formula><img class=tex src="../tex2png/cache/5685c685028e80cd7e723828c12d3880.png" alt=" n!_{\%p} = \underbrace{ 1 \cdot 2 \cdot \ldots \c[...]"><br><img class=tex src="../tex2png/cache/680c978b44708b069e29ac18ea587ef6.png" alt=" \cdot \underbrace{ 1 \cdot 2 \cdot \ldots \cdot ([...]"></p><p>Общую часть блоков посчитать легко &mdash; это просто <img class=tex src="../tex2png/cache/e0c1856676726f81738e22a91dd38853.png" alt="(p-1)!\ \rm{mod}\ p">, которую можно посчитать программно или по теореме Вильсона (Wilson) сразу найти <img class=tex src="../tex2png/cache/9127f4a5c1468317a15867bb5133dbfe.png" alt="(p-1)!\ {\rm mod}\ p = p-1">. Чтобы перемножить эти общие части всех блоков, надо найденную величину возвести в степень по модулю <img class=tex src="../tex2png/cache/2f8934466bea85c9661745280df23800.png" alt="p">, что можно сделать за <img class=tex src="../tex2png/cache/a4b96f8bbb97a929331f6c1104787527.png" alt="O(\log n)"> операций (см. <a href="binary_pow.html">Бинарное возведение в степень</a>; впрочем, можно заметить, что мы фактически возводим минус единицу в какую-то степень, а потому результатом всегда будет либо <img class=tex src="../tex2png/cache/1737ac55fdbc871d8c7d14245b749ccd.png" alt="1">, либо <img class=tex src="../tex2png/cache/433653455abe8dc3c97e9d8461e2adbe.png" alt="p-1">, в зависимости от чётности показателя. Значение в последнем, неполном блоке тоже можно посчитать отдельно за <img class=tex src="../tex2png/cache/aef60dc7cfef3d7c738f37ba2bd08dd4.png" alt="O(p)">. Остались только последние элементы блоков, рассмотрим их внимательнее:<p><p class=formula><img class=tex src="../tex2png/cache/b8295392eb63e0e0d26d5feee3608151.png" alt=" n!_{\%p} = \underbrace{ \ldots \cdot 1 } \cdot \u[...]"></p><p>И мы снова пришли к "модифицированному" факториалу, но уже меньшей размерности (столько, сколько было полных блоков, а их было <img class=tex src="../tex2png/cache/4e7dbebe05b6967905b887c3fc7f5093.png" alt="\left\lfloor n / p \right\rfloor">). Таким образом, вычисление "модифицированного" факториала <img class=tex src="../tex2png/cache/5a7d59c76b989f580e6c8a40e3695677.png" alt="n!_{\%p}"> мы свели за <img class=tex src="../tex2png/cache/aef60dc7cfef3d7c738f37ba2bd08dd4.png" alt="O(p)"> операций к вычислению уже <img class=tex src="../tex2png/cache/28743fc2d759d6bb98a400d434e84a01.png" alt="(n/p)!_{\%p}">. Раскрывая эту рекуррентную зависимость, мы получаем, что глубина рекурсии будет <img class=tex src="../tex2png/cache/6998cd503d0f9e102f3104b5911922f2.png" alt="O (\log_p n)">, итого <b>асимптотика</b> алгоритма получается <img class=tex src="../tex2png/cache/96f80332d8c6d33f4afe2cbe56ae410f.png" alt="O(p \log_p n)">.<p><h2 style="padding-top:40px;">Реализация</h2><p>Понятно, что при реализации не обязательно использовать рекурсию в явном виде: поскольку рекурсия хвостовая, её легко развернуть в цикл.<p><pre class="notranslate cpp"><span class="kw4">int</span> factmod <span class="br0">&#40;</span><span class="kw4">int</span> n, <span class="kw4">int</span> p<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw4">int</span> res <span class="sy1">=</span> <span class="nu0">1</span><span class="sy4">;</span>
	<span class="kw1">while</span> <span class="br0">&#40;</span>n <span class="sy1">&gt;</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		res <span class="sy1">=</span> <span class="br0">&#40;</span>res <span class="sy2">*</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>n<span class="sy2">/</span>p<span class="br0">&#41;</span> <span class="sy2">%</span> <span class="nu0">2</span> <span class="sy4">?</span> p<span class="sy2">-</span><span class="nu0">1</span> <span class="sy4">:</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy2">%</span> p<span class="sy4">;</span>
		<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">2</span><span class="sy4">;</span> i<span class="sy1">&lt;=</span>n<span class="sy2">%</span>p<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
			res <span class="sy1">=</span> <span class="br0">&#40;</span>res <span class="sy2">*</span> i<span class="br0">&#41;</span> <span class="sy2">%</span> p<span class="sy4">;</span>
		n <span class="sy2">/</span><span class="sy1">=</span> p<span class="sy4">;</span>
	<span class="br0">&#125;</span>
	<span class="kw1">return</span> res <span class="sy2">%</span> p<span class="sy4">;</span>
<span class="br0">&#125;</span></pre><p>Эта реализация работает за <img class=tex src="../tex2png/cache/96f80332d8c6d33f4afe2cbe56ae410f.png" alt="O(p \log_p n)">.<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr><p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'e-maxx';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script></td></tr></table></body></html>