<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>MAXimal :: algo :: Правильные скобочные последовательности</title><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><meta name="author" lang="ru" content="e-maxx" /><meta name="description" content="Алгоритмы, олимпиадное программирование, математика" /><meta name="keywords" content="алгоритмы программирование" /><meta name="google-site-verification" content="Pnjjj2XuxB0CTiqgDDvkp79bfSeDQ8Vw57iNeDJZkSc" /><link rel="stylesheet" type="text/css" href="../data/style.css"><script type="text/javascript" src="../data/jquery.js"></script><script type="text/javascript" src="../data/page-contents.js"></script><link rel="stylesheet" type="text/css" href="../geshi/geshi.css"><!--[if IE]><style>.menu a, .menu a:hover { width: 100%; }</style><![endif]--></head><body><table class=main cellpadding=0 cellspacing=0><tr><td class=title colspan=2><p>MAXimal</p></td></tr><tr><td class=menu><ul><li><a href="../index.php.html" >home</a></li><li><a href="index.html" class=current>algo</a></li><li><a href="../bookz/index.html" >bookz</a></li><li><a href="../forum/index.html" >forum</a></li><li><a href="../about.php.html" >about</a></li></ul></td><td class=content><p class=algoinfo>добавлено: 11 Jul 2008 20:45<br>редактировано: 18 Feb 2013 16:24</p><div id="contents-table"><p id="contents-table-title">Содержание <a href="bracket_sequences.html#" id="contents-hide">[скрыть]</a><a href="bracket_sequences.html#" id="contents-show" style="display:none">[показать]</a></p><div style="display:none"></div></div><h1>Правильные скобочные последовательности</h1><p>Правильной скобочной последовательностью называется строка, состоящая только из символов "скобки" (чаще всего рассматриваются только круглые скобки, но здесь будет рассматриваться и общий случай нескольких типов скобок), где каждой закрывающей скобке найдётся соответствующая открывающая (причём того же типа).<p>Здесь мы рассмотрим классические задачи на правильные скобочные последовательности (далее для краткости просто "последовательности"): проверка на правильность, количество последовательностей, генерация всех последовательностей, нахождение лексикографически следующей последовательности, нахождение <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k">-ой последовательности в отсортированном списке всех последовательностей, и, наоборот, определение номера последовательности. Каждая из задач рассмотрена в двух случаях &mdash; когда разрешены скобки только одного типа, и когда нескольких типов.<p><p><h2 style="padding-top:40px;">Проверка на правильность</h2><p>Пусть сначала разрешены скобки только одного типа, тогда проверить последовательность на правильность можно очень простым алгоритмом. Пусть <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> &mdash; это текущее количество открытых скобок. Изначально <img class=tex src="../tex2png/cache/3d497e3f1ff6cb56736feef33c03d76c.png" alt="\rm depth = 0">. Будем двигаться по строке слева направо, если текущая скобка открывающая, то увеличим <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> на единицу, иначе уменьшим. Если при этом когда-то получалось отрицательное число, или в конце работы алгоритма <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> отлично от нуля, то данная строка не является правильной скобочной последовательностью, иначе является.<p>Если допустимы скобки нескольких типов, то алгоритм нужно изменить. Вместо счётчика <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> следует создать стек, в который будем класть открывающие скобки по мере поступления. Если текущий символ строки &mdash; открывающая скобка, то кладём его в стек, а если закрывающая &mdash; то проверяем, что стек не пуст, и что на его вершине лежит скобка того же типа, что и текущая, и затем достаём эту скобку из стека. Если какое-либо из условий не выполнилось, или в конце работы алгоритма стек остался не пуст, то последовательность не является правильной скобочной, иначе является.<p>Таким образом, обе эти задачи мы научились решать за время <img class=tex src="../tex2png/cache/3bd5ae6ef1beefce202e062967bc49c1.png" alt="O(n)">.<p><p><h2 style="padding-top:40px;">Количество последовательностей</h2><p><h3 style="padding-top:15px;">Формула</h3><p>Количество правильных скобочных последовательностей с одним типом скобок можно вычислить как <b><a href="catalan_numbers.html">число Каталана</b></a>. Т.е. если есть <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> пар скобок (строка длины <img class=tex src="../tex2png/cache/02f3339bd527ea60f4b8a5fcb94023f1.png" alt="2n">), то количество будет равно:<p><p class=formula><img class=tex src="../tex2png/cache/40bf2c06fa93ae23b7886d49210f3c2e.png" alt=" \frac{1}{n+1} \cdot C^n_{2n}. "></p><p>Пусть теперь имеется не один, а <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> типов скобок. Тогда каждая пара скобок независимо от остальных может принимать один из <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> типов, а потому мы получаем такую формулу:<p><p class=formula><img class=tex src="../tex2png/cache/8c0fa40d0c328b0e442bd8aa12b964d7.png" alt=" \frac{1}{n+1} \cdot C^n_{2n} \cdot k^n. "></p><p><h3 style="padding-top:15px;">Динамическое программирование</h3><p>С другой стороны, к этой задаче можно подойти и с точки зрения <b>динамического программирования</b>. Пусть <img class=tex src="../tex2png/cache/2b494552b2a1eaa12179ea2eabd22b93.png" alt="d[n]"> &mdash; количество правильных скобочных последовательностей из <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> пар скобок. Заметим, что в первой позиции всегда будет стоять открывающая скобка. Понятно, что внутри этой пары скобок стоит какая-то правильная скобочная последовательность; аналогично, после этой пары скобок также стоит правильная скобочная последовательность. Теперь чтобы посчитать <img class=tex src="../tex2png/cache/2b494552b2a1eaa12179ea2eabd22b93.png" alt="d[n]">, переберём, сколько пар скобок <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> будет стоять внутри этой первой пары, тогда, соответственно, <img class=tex src="../tex2png/cache/b4d745c0075e93951000d7f3d10eeb94.png" alt="n-1-i"> пара скобок будет стоять после этой первой пары. Следовательно, формула для <img class=tex src="../tex2png/cache/2b494552b2a1eaa12179ea2eabd22b93.png" alt="d[n]"> имеет вид:<p><p class=formula><img class=tex src="../tex2png/cache/43e00c8d8eef19adfec5d9bd89ad162d.png" alt=" d[n] = \sum_{i=0}^{n-1} d[i] \cdot d[n-1-i]. "></p><p>Начальное значение для этой рекуррентной формулы &mdash; это <img class=tex src="../tex2png/cache/223726111372f97013f38ad64640ef78.png" alt="d[0] = 1">.<p><p><h2 style="padding-top:40px;">Нахождение всех последовательностей</h2><p>Иногда требуется найти и вывести все правильные скобочные последовательности указанной длины <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> (в данном случае <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> &mdash; это длина строки).<p>Для этого можно начать с лексикографически первой последовательности <img class=tex src="../tex2png/cache/7e5f4d5b120b715689601b5f4aab7821.png" alt="((\ldots(())\ldots))">, а затем находить каждый раз лексикографически следующую последовательность с помощью алгоритма, описанного в следующем разделе.<p>Но если ограничения не очень большие (<img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> до <img class=tex src="../tex2png/cache/0ac05f85299f79beea08861efc342895.png" alt="10-12">), то можно поступить значительно проще. Найдём всевозможные перестановки этих скобок (для этого удобно использовать функцию next_permutation()), их будет <img class=tex src="../tex2png/cache/f1e39d1a0b597fa9c965b5e504571420.png" alt="C_{2n}^n">, и каждую проверим на правильность вышеописанным алгоритмом, и в случае правильности выведем текущую последовательность.<p>Также процесс нахождения всех последовательностей можно оформить в виде рекурсивного перебора с отсечениями (что в идеале можно довести по скорости работы до первого алгоритма).<p><p><h2 style="padding-top:40px;">Нахождение следующей последовательности</h2><p>Здесь рассматривается только случай одного типа скобок.<p>По заданной правильной скобочной последовательности требуется найти правильную скобочную последовательность, которая находится следующей в лексикографическом порядке после текущей (или выдать "No solution", если такой не существует).<p>Понятно, что в целом алгоритм выглядит следующим образом: найдем такую самую правую открывающую скобку, которую мы имеем право заменить на закрывающую (так, чтобы в этом месте правильность не нарушалась), а всю оставшуюся справа строку заменим на лексикографически минимальную: т.е. сколько-то открывающих скобок, затем все оставшиеся закрывающие скобки. Иными словами, мы пытаемся оставить без изменения как можно более длинный префикс исходной последовательности, а в суффиксе эту последовательность заменяем на лексикографически минимальную.<p>Осталось научиться искать эту самую позицию первого изменения. Для этого будем идти по строке справа налево и поддерживать баланс <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> открытых и закрытых скобок (при встрече открывающей скобки будем уменьшать <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth">, а при закрывающей &mdash; увеличивать). Если в какой-то момент мы стоим на открывающей скобке, а баланс после обработки этого символа больше нуля, то мы нашли самую правую позицию, от которой мы можем начать изменять последовательность (в самом деле, <img class=tex src="../tex2png/cache/8a8bc19cc9584cb45eb99c645ef0baa9.png" alt="\rm depth > 0"> означает, что слева имеется не закрытая ещё скобка). Поставим в текущую позицию закрывающую скобку, затем максимально возможное количество открывающих скобок, а затем все оставшиеся закрывающие скобки, &mdash; ответ найден.<p>Если мы просмотрели всю строку и так и не нашли подходящую позицию, то текущая последовательность &mdash; максимальна, и ответа не существует.<p>Реализация алгоритма:<p><pre class="notranslate cpp">string s<span class="sy4">;</span>
<span class="kw3">cin</span> <span class="sy1">&gt;&gt;</span> s<span class="sy4">;</span>
<span class="kw4">int</span> n <span class="sy1">=</span> <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span> s.<span class="me1">length</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
string ans <span class="sy1">=</span> <span class="st0">&quot;No solution&quot;</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span>n<span class="sy2">-</span><span class="nu0">1</span>, depth<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&gt;=</span><span class="nu0">0</span><span class="sy4">;</span> <span class="sy2">--</span>i<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">==</span> <span class="st0">'('</span><span class="br0">&#41;</span>
		<span class="sy2">--</span>depth<span class="sy4">;</span>
	<span class="kw1">else</span>
		<span class="sy2">++</span>depth<span class="sy4">;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>s<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy1">==</span> <span class="st0">'('</span> <span class="sy3">&amp;&amp;</span> depth <span class="sy1">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="sy2">--</span>depth<span class="sy4">;</span>
		<span class="kw4">int</span> open <span class="sy1">=</span> <span class="br0">&#40;</span>n<span class="sy2">-</span>i<span class="sy2">-</span><span class="nu0">1</span> <span class="sy2">-</span> depth<span class="br0">&#41;</span> <span class="sy2">/</span> <span class="nu0">2</span><span class="sy4">;</span>
		<span class="kw4">int</span> close <span class="sy1">=</span> n<span class="sy2">-</span>i<span class="sy2">-</span><span class="nu0">1</span> <span class="sy2">-</span> open<span class="sy4">;</span>
		ans <span class="sy1">=</span> s.<span class="me1">substr</span><span class="br0">&#40;</span><span class="nu0">0</span>,i<span class="br0">&#41;</span> <span class="sy2">+</span> <span class="st0">')'</span> <span class="sy2">+</span> string <span class="br0">&#40;</span>open, <span class="st0">'('</span><span class="br0">&#41;</span> <span class="sy2">+</span> string <span class="br0">&#40;</span>close, <span class="st0">')'</span><span class="br0">&#41;</span><span class="sy4">;</span>
		<span class="kw1">break</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
<span class="kw3">cout</span> <span class="sy1">&lt;&lt;</span> ans<span class="sy4">;</span></pre><p>Таким образом, мы решили эту задачу за <img class=tex src="../tex2png/cache/3bd5ae6ef1beefce202e062967bc49c1.png" alt="O(n)">.<p><p><h2 style="padding-top:40px;">Номер последовательности</h2><p>Здесь пусть <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> &mdash; количество пар скобок в последовательности. Требуется по заданной правильной скобочной последовательности найти её номер в списке лексикографически упорядоченных правильных скобочных последовательностей.<p>Научимся считать вспомогательную <b>динамику</b> <img class=tex src="../tex2png/cache/a18f11689b09b23faa10c78d6b244cf8.png" alt="d[i][j]">, где <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> &mdash; длина скобочной последовательности (она "полуправильна": всякой закрывающей скобке имеется парная открывающая, но не все открытые скобки закрыты), <img class=tex src="../tex2png/cache/f2761432c5377ee4ded848884be6d407.png" alt="j"> &mdash; баланс (т.е. разность между количеством открывающих и закрывающих скобок), <img class=tex src="../tex2png/cache/a18f11689b09b23faa10c78d6b244cf8.png" alt="d[i][j]"> &mdash; количество таких последовательностей. При подсчёте этой динамики мы считаем, что скобки бывают только одного типа.<p>Считать эту динамику можно следующим образом. Пусть <img class=tex src="../tex2png/cache/a18f11689b09b23faa10c78d6b244cf8.png" alt="d[i][j]"> &mdash; величина, которую мы хотим посчитать. Если <img class=tex src="../tex2png/cache/ce7cba656d8c7655b2a930a16d4dfd22.png" alt="i=0">, то ответ понятен сразу: <img class=tex src="../tex2png/cache/c0dc0502e006315a9d29400b87f15c03.png" alt="d[0][0] = 1">, все остальные <img class=tex src="../tex2png/cache/96adec7c3664dcfda642f97126952b3c.png" alt="d[0][j] = 0">. Пусть теперь <img class=tex src="../tex2png/cache/a08b4bbdb9c409b29f81b47df89a6af8.png" alt="i > 0">, тогда мысленно переберём, чему был равен последний символ этой последовательности. Если он был равен '(', то до этого символа мы находились в состоянии <img class=tex src="../tex2png/cache/0f2f1ede013f873ad2051165d527862a.png" alt="(i-1,j-1)">. Если он был равен ')', то предыдущим было состояние <img class=tex src="../tex2png/cache/978d033646390935a94ab39494f71a17.png" alt="(i-1,j+1)">. Таким образом, получаем формулу:<p><p class=formula><img class=tex src="../tex2png/cache/d1419f75e934c8ede4097e1ae24e38ef.png" alt=" d[i][j] = d[i-1][j-1] + d[i-1][j+1] "></p><p>(считается, что все значения <img class=tex src="../tex2png/cache/a18f11689b09b23faa10c78d6b244cf8.png" alt="d[i][j]"> при отрицательном <img class=tex src="../tex2png/cache/f2761432c5377ee4ded848884be6d407.png" alt="j"> равны нулю). Таким образом, эту динамику мы можем посчитать за <img class=tex src="../tex2png/cache/712c5a4a9bec3c435e92314194c99f95.png" alt="O(n^2)">.<p>Перейдём теперь к решению самой задачи.<p>Сначала пусть допустимы только скобки <b>одного</b> типа. Заведём счётчик <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> глубины вложенности в скобки, и будем двигаться по последовательности слева направо. Если текущий символ <img class=tex src="../tex2png/cache/fd6f470cea3a6f4a8e40703f1a939deb.png" alt="s[i]"> (<img class=tex src="../tex2png/cache/a16617a02b532ad2d7064c12c17780fd.png" alt="i=0 \ldots 2n-1">) равен '(', то мы увеличиваем <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> на 1 и переходим к следующему символу. Если же текущий символ равен ')', то мы должны прибавить к ответу <img class=tex src="../tex2png/cache/620859118284daa274b51627a01c1773.png" alt="d[2n-i-1][\rm depth+1]">, тем самым учитывая, что в этой позиции мог бы стоять символ '(' (который бы привёл к лексикографически меньшей последовательности, чем текущая); затем мы уменьшаем <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> на единицу.<p>Пусть теперь разрешены скобки <b>нескольких</b> <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> типов. Тогда при рассмотрении текущего символа <img class=tex src="../tex2png/cache/fd6f470cea3a6f4a8e40703f1a939deb.png" alt="s[i]"> до пересчёта <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> мы должны перебирать все скобки, которые меньше текущего символа, пробовать ставить эту скобку в текущую позицию (получая тем самым новый баланс <img class=tex src="../tex2png/cache/a2b25d19dd69e582c7b973e042c63c6f.png" alt="\rm ndepth = \rm depth \pm 1">), и и прибавлять к ответу количество соответствующих "хвостов" - завершений (которые имеют длину <img class=tex src="../tex2png/cache/dd1fb5ce27f1091d385d037edbcf821c.png" alt="2n-i-1">, баланс <img class=tex src="../tex2png/cache/2686e920872dcde2f6fb2f82aecdcd1e.png" alt="\rm ndepth"> и <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> типов скобок). Утверждается, что формула для этого количества имеет вид:<p><p class=formula><img class=tex src="../tex2png/cache/000058deda7c264bd7cb40c829e8faa7.png" alt=" d[2n-i-1][{\rm ndepth}] \cdot k^{ (2n-i-1 - {\rm [...]"></p><p>Эта формула выводится из следующих соображений. Сначала мы "забываем" про то, что скобки бывают нескольких типов, и просто берём ответ из <img class=tex src="../tex2png/cache/40e937753ba45cfa536a2bbb5e04848e.png" alt="d[2n-i-1][{\rm ndepth}]">. Теперь посчитаем, как изменится ответ из-за наличия <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> типов скобок. У нас имеется <img class=tex src="../tex2png/cache/dd1fb5ce27f1091d385d037edbcf821c.png" alt="2n-i-1"> неопределённых позиций, из которых <img class=tex src="../tex2png/cache/2686e920872dcde2f6fb2f82aecdcd1e.png" alt="\rm ndepth"> являются скобками, закрывающими какие-то из открытых ранее, &mdash; значит, тип таких скобок мы варьировать не можем. А вот все остальные скобки (а их будет <img class=tex src="../tex2png/cache/cedf936153f816e9e68bd97db1ae5b4c.png" alt="(2n-i-1 - {\rm ndepth})/2"> пар) могут быть любого из <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> типов, поэтому ответ умножается на эту степень числа <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k">.<p><p><h2 style="padding-top:40px;">Нахождение <img class=tex src="../tex2png/cache/336a051837a2ed662422914225a362d0.png" alt="k">-ой последовательности</h2><p>Здесь пусть <img class=tex src="../tex2png/cache/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> &mdash; количество пар скобок в последовательности. В данной задаче по заданному <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> требуется найти <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k">-ую правильную скобочную последовательность в списке лексикографически упорядоченных последовательностей.<p>Как и в предыдущем разделе, посчитаем <b>динамику</b> <img class=tex src="../tex2png/cache/a18f11689b09b23faa10c78d6b244cf8.png" alt="d[i][j]"> &mdash; количество правильных скобочных последовательностей длины <img class=tex src="../tex2png/cache/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> с балансом <img class=tex src="../tex2png/cache/f2761432c5377ee4ded848884be6d407.png" alt="j">.<p>Пусть сначала допустимы только скобки <b>одного</b> типа.<p>Будем двигаться по символам искомой строки, с <img class=tex src="../tex2png/cache/d796aaaffd5bff4144c8ac3509c1d33d.png" alt="0">-го по <img class=tex src="../tex2png/cache/072e6ac03ecf104f2cadad60066d7d36.png" alt="2n-1">-ый. Как и в предыдущей задаче, будем хранить счётчик <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> &mdash; текущую глубину вложенности в скобки. В каждой текущей позиции будем перебирать возможный символ - открывающую скобку или закрывающую. Пусть мы хотим поставить сюда открывающую скобку, тогда мы должны посмотреть на значение <img class=tex src="../tex2png/cache/f37166319114c2e3181316d65abea7d9.png" alt="d[i+1][\rm depth+1]">. Если оно <img class=tex src="../tex2png/cache/9d2dac01a5ebeff005f7464d36969397.png" alt="\ge k">, то мы ставим в текущую позицию открывающую скобку, увеличиваем <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth"> на единицу и переходим к следующему символу. Иначе мы отнимаем от <img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> величину <img class=tex src="../tex2png/cache/f37166319114c2e3181316d65abea7d9.png" alt="d[i+1][\rm depth+1]">, ставим закрывающую скобку и уменьшаем значение <img class=tex src="../tex2png/cache/da4aa75234e7ead2f6649ebe369eebe3.png" alt="\rm depth">. В конце концов мы и получим искомую скобочную последовательность.<p>Реализация на языке Java с использованием длинной арифметики:<p><pre class="notranslate cpp"><span class="kw4">int</span> n<span class="sy4">;</span>  BigInteger k<span class="sy4">;</span>  <span class="co1">// входные данные</span>
&nbsp;
BigInteger d<span class="br0">&#91;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy1">=</span> <span class="kw3">new</span> BigInteger <span class="br0">&#91;</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>n<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;=</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> j<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> j<span class="sy1">&lt;=</span>n<span class="sy4">;</span> <span class="sy2">++</span>j<span class="br0">&#41;</span>
		d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="br0">&#93;</span> <span class="sy1">=</span> BigInteger.<span class="me1">ZERO</span><span class="sy4">;</span>
d<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy1">=</span> BigInteger.<span class="me1">ONE</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> j<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> j<span class="sy1">&lt;=</span>n<span class="sy4">;</span> <span class="sy2">++</span>j<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>j<span class="sy2">+</span><span class="nu0">1</span> <span class="sy1">&lt;=</span> n<span class="br0">&#41;</span>
			d<span class="br0">&#91;</span>i<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy1">=</span> d<span class="br0">&#91;</span>i<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">add</span><span class="br0">&#40;</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy4">;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>j <span class="sy1">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
			d<span class="br0">&#91;</span>i<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy1">=</span> d<span class="br0">&#91;</span>i<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">add</span><span class="br0">&#40;</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
&nbsp;
String ans <span class="sy1">=</span> <span class="kw3">new</span> String<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
<span class="kw1">if</span> <span class="br0">&#40;</span>k.<span class="me1">compareTo</span><span class="br0">&#40;</span> d<span class="br0">&#91;</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="br0">&#41;</span> <span class="sy1">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
	ans <span class="sy1">=</span> <span class="st0">&quot;No solution&quot;</span><span class="sy4">;</span>
<span class="kw1">else</span> <span class="br0">&#123;</span>
	<span class="kw4">int</span> depth <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="sy2">-</span><span class="nu0">1</span><span class="sy4">;</span> i<span class="sy1">&gt;=</span><span class="nu0">0</span><span class="sy4">;</span> <span class="sy2">--</span>i<span class="br0">&#41;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>depth<span class="sy2">+</span><span class="nu0">1</span> <span class="sy1">&lt;=</span> n <span class="sy3">&amp;&amp;</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>depth<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">compareTo</span><span class="br0">&#40;</span> k <span class="br0">&#41;</span> <span class="sy1">&gt;=</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			ans <span class="sy2">+</span><span class="sy1">=</span> <span class="st0">'('</span><span class="sy4">;</span>
			<span class="sy2">++</span>depth<span class="sy4">;</span>
		<span class="br0">&#125;</span>
		<span class="kw1">else</span> <span class="br0">&#123;</span>
			ans <span class="sy2">+</span><span class="sy1">=</span> <span class="st0">')'</span><span class="sy4">;</span>
			<span class="kw1">if</span> <span class="br0">&#40;</span>depth<span class="sy2">+</span><span class="nu0">1</span> <span class="sy1">&lt;=</span> n<span class="br0">&#41;</span>
				k <span class="sy1">=</span> k.<span class="me1">subtract</span><span class="br0">&#40;</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>depth<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy4">;</span>
			<span class="sy2">--</span>depth<span class="sy4">;</span>
		<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre><p>Пусть теперь разрешён не один, а <b><img class=tex src="../tex2png/cache/252410059470b019db6fd4c3b844a348.png" alt="k"> типов</b> скобок. Тогда алгоритм решения будет отличаться от предыдущего случая только тем, что мы должны домножать значение <img class=tex src="../tex2png/cache/a986cfa9d45b9ed6b202ba8a6791a90b.png" alt="D[i+1][\rm ndepth]"> на величину <img class=tex src="../tex2png/cache/a115b2ea6fde999074d08e973605c418.png" alt="k^{(2n-i-1- \rm ndepth)/2}">, чтобы учесть, что в этом остатке могли быть скобки различных типов, а парных скобок в этом остатке будет только <img class=tex src="../tex2png/cache/0b2317452cc2528d7c45bb6655a49490.png" alt="2n-i-1- \rm ndepth">, поскольку <img class=tex src="../tex2png/cache/2686e920872dcde2f6fb2f82aecdcd1e.png" alt="\rm ndepth"> скобок являются закрывающими для открывающих скобок, находящихся вне этого остатка (а потому их типы мы варьировать не можем).<p>Реализация на языке Java для случая двух типов скобок - круглых и квадратных:<p><pre class="notranslate cpp"><span class="kw4">int</span> n<span class="sy4">;</span>  BigInteger k<span class="sy4">;</span>  <span class="co1">// входные данные</span>
&nbsp;
BigInteger d<span class="br0">&#91;</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy1">=</span> <span class="kw3">new</span> BigInteger <span class="br0">&#91;</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>n<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;=</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> j<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> j<span class="sy1">&lt;=</span>n<span class="sy4">;</span> <span class="sy2">++</span>j<span class="br0">&#41;</span>
		d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="br0">&#93;</span> <span class="sy1">=</span> BigInteger.<span class="me1">ZERO</span><span class="sy4">;</span>
d<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy1">=</span> BigInteger.<span class="me1">ONE</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">&#41;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> j<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> j<span class="sy1">&lt;=</span>n<span class="sy4">;</span> <span class="sy2">++</span>j<span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>j<span class="sy2">+</span><span class="nu0">1</span> <span class="sy1">&lt;=</span> n<span class="br0">&#41;</span>
			d<span class="br0">&#91;</span>i<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy1">=</span> d<span class="br0">&#91;</span>i<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">add</span><span class="br0">&#40;</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy4">;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span>j <span class="sy1">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
			d<span class="br0">&#91;</span>i<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy1">=</span> d<span class="br0">&#91;</span>i<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">add</span><span class="br0">&#40;</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>j<span class="br0">&#93;</span> <span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
&nbsp;
String ans <span class="sy1">=</span> <span class="kw3">new</span> String<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy4">;</span>
<span class="kw4">int</span> depth <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
<span class="kw4">char</span> <span class="br0">&#91;</span><span class="br0">&#93;</span> stack <span class="sy1">=</span> <span class="kw3">new</span> <span class="kw4">char</span><span class="br0">&#91;</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="sy4">;</span>
<span class="kw4">int</span> stacksz <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i<span class="sy1">=</span>n<span class="sy2">*</span><span class="nu0">2</span><span class="sy2">-</span><span class="nu0">1</span><span class="sy4">;</span> i<span class="sy1">&gt;=</span><span class="nu0">0</span><span class="sy4">;</span> <span class="sy2">--</span>i<span class="br0">&#41;</span> <span class="br0">&#123;</span>
	BigInteger cur<span class="sy4">;</span>
	<span class="co1">// '('</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>depth<span class="sy2">+</span><span class="nu0">1</span> <span class="sy1">&lt;=</span> n<span class="br0">&#41;</span>
		cur <span class="sy1">=</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>depth<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">shiftLeft</span><span class="br0">&#40;</span> <span class="br0">&#40;</span>i<span class="sy2">-</span>depth<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy2">/</span><span class="nu0">2</span> <span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw1">else</span>
		cur <span class="sy1">=</span> BigInteger.<span class="me1">ZERO</span><span class="sy4">;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>cur.<span class="me1">compareTo</span><span class="br0">&#40;</span> k <span class="br0">&#41;</span> <span class="sy1">&gt;=</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		ans <span class="sy2">+</span><span class="sy1">=</span> <span class="st0">'('</span><span class="sy4">;</span>
		stack<span class="br0">&#91;</span>stacksz<span class="sy2">++</span><span class="br0">&#93;</span> <span class="sy1">=</span> <span class="st0">'('</span><span class="sy4">;</span>
		<span class="sy2">++</span>depth<span class="sy4">;</span>
		<span class="kw1">continue</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
	k <span class="sy1">=</span> k.<span class="me1">subtract</span><span class="br0">&#40;</span> cur <span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="co1">// ')'</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>stacksz <span class="sy1">&gt;</span> <span class="nu0">0</span> <span class="sy3">&amp;&amp;</span> stack<span class="br0">&#91;</span>stacksz<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy1">==</span> <span class="st0">'('</span> <span class="sy3">&amp;&amp;</span> depth<span class="sy2">-</span><span class="nu0">1</span> <span class="sy1">&gt;=</span> <span class="nu0">0</span><span class="br0">&#41;</span>
		cur <span class="sy1">=</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>depth<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">shiftLeft</span><span class="br0">&#40;</span> <span class="br0">&#40;</span>i<span class="sy2">-</span>depth<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy2">/</span><span class="nu0">2</span> <span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw1">else</span>
		cur <span class="sy1">=</span> BigInteger.<span class="me1">ZERO</span><span class="sy4">;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>cur.<span class="me1">compareTo</span><span class="br0">&#40;</span> k <span class="br0">&#41;</span> <span class="sy1">&gt;=</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		ans <span class="sy2">+</span><span class="sy1">=</span> <span class="st0">')'</span><span class="sy4">;</span>
		<span class="sy2">--</span>stacksz<span class="sy4">;</span>
		<span class="sy2">--</span>depth<span class="sy4">;</span>
		<span class="kw1">continue</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
	k <span class="sy1">=</span> k.<span class="me1">subtract</span><span class="br0">&#40;</span> cur <span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="co1">// '['</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>depth<span class="sy2">+</span><span class="nu0">1</span> <span class="sy1">&lt;=</span> n<span class="br0">&#41;</span>
		cur <span class="sy1">=</span> d<span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#91;</span>depth<span class="sy2">+</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">shiftLeft</span><span class="br0">&#40;</span> <span class="br0">&#40;</span>i<span class="sy2">-</span>depth<span class="sy2">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy2">/</span><span class="nu0">2</span> <span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="kw1">else</span>
		cur <span class="sy1">=</span> BigInteger.<span class="me1">ZERO</span><span class="sy4">;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>cur.<span class="me1">compareTo</span><span class="br0">&#40;</span> k <span class="br0">&#41;</span> <span class="sy1">&gt;=</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		ans <span class="sy2">+</span><span class="sy1">=</span> <span class="st0">'['</span><span class="sy4">;</span>
		stack<span class="br0">&#91;</span>stacksz<span class="sy2">++</span><span class="br0">&#93;</span> <span class="sy1">=</span> <span class="st0">'['</span><span class="sy4">;</span>
		<span class="sy2">++</span>depth<span class="sy4">;</span>
		<span class="kw1">continue</span><span class="sy4">;</span>
	<span class="br0">&#125;</span>
	k <span class="sy1">=</span> k.<span class="me1">subtract</span><span class="br0">&#40;</span> cur <span class="br0">&#41;</span><span class="sy4">;</span>
	<span class="co1">// ']'</span>
	ans <span class="sy2">+</span><span class="sy1">=</span> <span class="st0">']'</span><span class="sy4">;</span>
	<span class="sy2">--</span>stacksz<span class="sy4">;</span>
	<span class="sy2">--</span>depth<span class="sy4">;</span>
<span class="br0">&#125;</span></pre><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr><p>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'e-maxx';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script></td></tr></table></body></html>